/**
 * Generated by scripts/prefetch.js
 * Options:
 *     name: "wikiplus-highlight"
 *     url: "https://cdn.jsdelivr.net/npm/wikiplus-highlight"
 *     file: "src/gadgets/wikiplus-highlight/MediaWiki:Gadget-wikiplus-highlight.js"
 */
/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/wikiplus-highlight@2.25.3/main.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
/**
 * @name Wikiplus-highlight Wikiplus编辑器的CodeMirror语法高亮扩展
 * @author Bhsd <https://github.com/bhsd-harry>
 * @author 机智的小鱼君 <https://github.com/Dragon-Fish>
 * @license GPL-3.0
 */
(async()=>{"use strict";if(mw.libs.wphl)return;mw.libs.wphl={};const e="2.25.2",i="object"==typeof mw.storage&&"function"==typeof mw.storage.getObject?mw.storage:{getObject(e){const i=localStorage.getItem(e);if(!1===i)return!1;try{return JSON.parse(i)}catch(e){return null}},setObject(e,i){try{return localStorage.setItem(e,JSON.stringify(i))}catch(e){return!1}}};Object.fromEntries=Object.fromEntries||(e=>{const i={};for(const[t,o]of e)i[t]=o;return i});const t=e=>"function"==typeof e.flat?e.flat():e.reduce(((e,i)=>e.concat(i)),[]),o=(i=e)=>i.split(".").map(Number),n=(e,...i)=>mw.msg(`wphl-${e}`,...i),a=(...e)=>$($.parseHTML(n(...e))),s=(...e)=>()=>{const i=$("<p>",{html:n(...e)});return mw.notify(i,{type:"success",autoHideSeconds:"long",tag:"wikiplus-highlight"}),i},r=o().slice(0,2).join("."),l="//fastly.jsdelivr.net",d="npm/codemirror@5.65.3",c="gh/bhsd-harry/codemirror-mediawiki@1.1.6",m=`npm/wikiplus-highlight@${r}`,{config:{values:{wgPageName:g,wgNamespaceNumber:p,wgPageContentModel:u,wgServerName:w,wgScriptPath:h,wgUserLanguage:k,skin:f}}}=mw,b=null!==mw.loader.getState("ext.CodeMirror"),x=i.getObject("InPageEditMwConfig")||{},y=`${w}${h}`,C=x[y]||{},j=!(C.time>Date.now()-2592e6),S={css:"css","sanitized-css":"css",javascript:"javascript",json:"javascript",wikitext:"mediawiki"},M=b?{lib:"ext.CodeMirror.lib",css:"ext.CodeMirror.lib.mode.css",javascript:"ext.CodeMirror.lib.mode.javascript",lua:`${d}/mode/lua/lua.min.js`,mediawiki:j?"ext.CodeMirror.data":[],htmlmixed:"ext.CodeMirror.lib.mode.htmlmixed",xml:[]}:{lib:`${d}/lib/codemirror.min.js`,css:`${d}/mode/css/css.min.js`,javascript:`${d}/mode/javascript/javascript.min.js`,lua:`${d}/mode/lua/lua.min.js`,mediawiki:[],htmlmixed:`${d}/mode/htmlmixed/htmlmixed.min.js`,xml:`${d}/mode/xml/xml.min.js`},W={searchcursor:`${d}/addon/search/searchcursor.min.js`,search:`${m}/search.min.js`,markSelection:`${d}/addon/selection/mark-selection.min.js`,activeLine:`${d}/addon/selection/active-line.min.js`,trailingspace:`${d}/addon/edit/trailingspace.min.js`,matchBrackets:`${d}/addon/edit/matchbrackets.min.js`,closeBrackets:`${d}/addon/edit/closebrackets.min.js`,matchTags:`${m}/matchtags.min.js`,fold:`${m}/fold.min.js`,wikiEditor:"ext.wikiEditor",contextmenu:"mediawiki.Title",lint:`${d}/addon/lint/lint.min.js`,annotateScrollbar:`${d}/addon/scroll/annotatescrollbar.min.js`,parser:"gh/bhsd-harry/wikiparser-node@0.5.4-b/bundle/bundle.min.js",lintWikitext:`${m}/lint.min.js`},v=[{option:"styleSelectedText",addon:"search",download:"markSelection",only:!0,complex:()=>!O.has("wikiEditor")},{option:"styleActiveLine",addon:"activeLine"},{option:"showTrailingSpace",addon:"trailingspace"},{option:"matchBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||{bracketRegex:/[{}[\]]/}},{option:"autoCloseBrackets",addon:"closeBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||'()[]{}""'},{option:"matchTags",addon:["matchTags","fold"],modes:["mediawiki","widget"]},{option:"fold",modes:["mediawiki","widget"]}],O=new Set(i.getObject("Wikiplus-highlight-addons")||["search"]);let E=i.getObject("Wikiplus-highlight-indent")||4;const _={'"':"quot","'":"apos","<":"lt",">":"gt","&":"amp"," ":"nbsp"},z=e=>i=>{i.replaceSelection(i.getSelection().split("\n").map(e).join("\n"),"around")},I=z((e=>[...e].map((e=>{if(e in _)return`&${_[e]};`;const i=e.codePointAt();return i<256?`&#${i};`:`&#x${i.toString(16)};`})).join(""))),T=({keyMap:e})=>e.default===e.pcDefault,A={"Ctrl-/":I,"Ctrl-\\":z(encodeURIComponent)},L={"Cmd-/":I,"Cmd-\\":z(encodeURIComponent)},P=(e,i)=>{if("mediawiki"!==i&&"widget"!==i||!O.has("contextmenu"))return;const t=$(e.getWrapperElement()).addClass("CodeMirror-contextmenu"),{functionSynonyms:[o]}=mw.config.get("extCodeMirrorConfig")||{functionSynonyms:[{invoke:"invoke","调用":"invoke",widget:"widget","小工具":"widget"}]},n=e=>Object.keys(o).filter((i=>o[i]===e)).map((e=>e.startsWith("#")?e:`#${e}`)),a=n("invoke"),s=n("widget");t.contextmenu((({pageX:i,pageY:t})=>{const o=e.coordsChar({left:i,top:t}),{line:n,ch:r}=o,l=e.getTokenTypeAt(o);if(!/\bmw-(?:template-name|parserfunction)\b/.test(l))return;const d=e.getLineTokens(n);for(let e=d.length-1;e>0;e--){const{type:i,end:t,string:o}=d[e];d[e-1].type===i&&(d[e-1].end=t,d[e-1].string+=o,d.splice(e,1))}const c=d.findIndex((({start:e,end:i})=>e<r&&i>=r)),m=d[c].string.replace(/\u200E/g,"").replace(/_/g," ").trim();if(/\bmw-template-name\b/.test(l)){const e=new mw.Title(m);return 0!==e.namespace||m.startsWith(":")?open(e.getUrl(),"_blank"):open(mw.util.getUrl(`Template:${m}`),"_blank"),!1}if(c<2||!/\bmw-parserfunction-delimiter\b/.test(d[c-1].type)||!/\bmw-parserfunction-name\b/.test(d[c-2].type))return;const g=d[c-2].string.trim().toLowerCase();if(a.includes(g))open(mw.util.getUrl(`Module:${m}`),"_blank");else{if(!s.includes(g))return;open(mw.util.getUrl(`Widget:${m}`,{action:"edit"}),"_blank")}return!1}))},D=i.getObject("Wikiplus-highlight-i18n")||{};let N;D["wphl-version"]?((e,i)=>{const[t,n]=o(e),[a,s]=o(i);return t<a||t===a&&n<s})(D["wphl-version"],e)&&(N=s("welcome-new-addon",e,1)):N=s("welcome");const F={zh:"zh-hans","zh-hans":"zh-hans","zh-cn":"zh-hans","zh-my":"zh-hans","zh-sg":"zh-hans","zh-hant":"zh-hant","zh-tw":"zh-hant","zh-hk":"zh-hant","zh-mo":"zh-hant",ka:"ka"}[k]||"en",H=`${l}/${m}/i18n/${F}.json`,U=D["wphl-version"]===r,V=async()=>{U&&D["wphl-lang"]===F||(Object.assign(D,await $.ajax(`${H}`,{dataType:"json",cache:!0})),i.setObject("Wikiplus-highlight-i18n",D)),mw.messages.set(D)},B=Promise.all([mw.loader.using("mediawiki.util"),V()]),Q=e=>e.length>0?mw.loader.using(e):Promise.resolve(),q=e=>e.length>0?$.ajax(`${l}/${e.length>1?"combine/":""}${e.join()}`,{dataType:"script",cache:!0}):Promise.resolve(),K=async(e,i)=>{const t=e.filter((e=>!e.includes("/"))),o=e.filter((e=>e.includes("/")));return!0===i?(await Q(t),q(o)):!1===i?(await q(o),Q(t)):Promise.all([Q(t),q(o)])};let J;const R=(e,i=!1)=>{const t=[];for(const{option:o,addon:n=o,download:a=(Array.isArray(n)?o:n),only:s}of v)s&&i||o in e.optionHandlers||!G(n,O)||t.push(W[a]);return t},G=(e,i)=>Array.isArray(e)?e.some((e=>i.has(e))):i.has(e),X=e=>{let i=[];const t="function"==typeof window.CodeMirror,o=t?window.CodeMirror:{modes:{},prototype:{},commands:{},optionHandlers:{},helpers:{}};if(t||(i.push(M.lib),b||mw.loader.load(`${l}/${d}/lib/codemirror.min.css`,"text/css")),"mediawiki"===e&&C.config&&C.config.tags.html&&(e="html"),"mediawiki"!==e&&"widget"!==e||o.modes.mediawiki||(mw.loader.load(`${l}/${c}/mediawiki.min.css`,"text/css"),i.push(`${c}/mediawiki.min.js`)),"widget"===e||"html"===e)for(const e of["css","javascript","mediawiki","htmlmixed","xml"])o.modes[e]||(i=i.concat(M[e]));else i=i.concat(M[e]);if(o.prototype.getSearchCursor||!O.has("search")||O.has("wikiEditor")||i.push(W.searchcursor),!o.prototype.annotateScrollbar&&"mediawiki"===e&&O.has("lint")&&i.push(W.annotateScrollbar),o.commands.findForward||!O.has("search")||O.has("wikiEditor")||i.push(W.search),!window.Parser&&"mediawiki"===e&&O.has("lint")&&i.push(W.parser),!o.optionHandlers.lint&&"mediawiki"===e&&O.has("lint")&&(mw.loader.load(`${l}/${d}/addon/lint/lint.min.css`,"text/css"),i.push(W.lint)),o.helpers.lint&&o.helpers.lint.mediawiki||"mediawiki"!==e||!O.has("lint")||i.push(W.lintWikitext),O.has("wikiEditor")){const e=mw.loader.getState("ext.wikiEditor");e?"ready"!==e&&i.push(W.wikiEditor):O.delete("wikiEditor")}return"ready"!==mw.loader.getState("mediawiki.Title")&&O.has("contextmenu")&&i.push(W.contextmenu),i.push(...R(o)),K(i,t?void 0:b)},Y=e=>{x[y]={config:e,time:Date.now()},i.setObject("InPageEditMwConfig",x)},Z=e=>t(e.map((({aliases:e,name:i})=>e.map((e=>({alias:e,name:i})))))),ee=e=>Object.fromEntries(e.map((({alias:e,name:i})=>[e.replace(/:$/,""),i]))),ie=async(e,i)=>{if("mediawiki"!==e&&"widget"!==e)return;b&&j&&await i;let t=mw.config.get("extCodeMirrorConfig");if(t||j||!U||(({config:t}=C),t.tags.ref&&(t.tagModes.ref="text/mediawiki"),mw.config.set("extCodeMirrorConfig",t)),t&&t.redirect&&t.img)return t;const{query:{magicwords:o,extensiontags:n,functionhooks:a,variables:s}}=await(new mw.Api).get({meta:"siteinfo",siprop:t?"magicwords":"magicwords|extensiontags|functionhooks|variables",formatversion:2}),r=["msg","raw","msgnw","subst","safesubst"];if(t){const{functionSynonyms:[e]}=t;if(!e.subst){const i=Z(o.filter((({name:e})=>r.includes(e))));for(const{alias:t,name:o}of i)e[t.replace(/:$/,"")]=o}}else{t={tagModes:{pre:"mw-tag-pre",nowiki:"mw-tag-nowiki",ref:"text/mediawiki"},tags:Object.fromEntries(n.map((e=>[e.slice(1,-1),!0]))),urlProtocols:mw.config.get("wgUrlProtocols")};const e=new Set([...a,...s,...r]),i=o.filter((({name:i,aliases:t})=>t.some((e=>/^__.+__$/.test(e)))||e.has(i))),l=Z(i.filter((e=>e["case-sensitive"]))),d=Z(i.filter((e=>!e["case-sensitive"]))).map((({alias:e,name:i})=>({alias:e.toLowerCase(),name:i})));t.doubleUnderscore=[ee(d.filter((({alias:e})=>/^__.+__$/.test(e)))),ee(l.filter((({alias:e})=>/^__.+__$/.test(e))))],t.functionSynonyms=[ee(d.filter((({alias:e})=>!/^__.+__|^#$/.test(e)))),ee(l.filter((({alias:e})=>!/^__.+__|^#$/.test(e))))]}return t.redirect=o.find((({name:e})=>"redirect"===e)).aliases,t.img=ee(Z(o.filter((({name:e})=>e.startsWith("img_"))))),mw.config.set("extCodeMirrorConfig",t),Y(t),t},te={getContents:()=>J.getValue(),setContents(e){return J.setValue(e),this},getSelection:()=>J.getSelection(),setSelection(e){return J.setSelection(J.posFromIndex(e.start),"end"in e?J.posFromIndex(e.end):void 0),J.focus(),this},replaceSelection(e){return J.replaceSelection(e),this},getCaretPosition(e){const i=J.indexFromPos(J.getCursor("from")),t=J.indexFromPos(J.getCursor("to"));return e.startAndEnd?[i,t]:i},scrollToCaretPosition(){return J.scrollIntoView(),this}},oe=async(e,t)=>{const o=t?"javascript":await(async()=>{if(g.endsWith("/doc"))return"mediawiki";if(274!==p&&828!==p)return S[u];const e=274===p?"Widget":"Lua";return await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),await OO.ui.confirm(n("contentmodel"),{actions:[{label:e},{label:"Wikitext",action:"accept"}]})?"mediawiki":e.toLowerCase()})(),a=X(o),[s]=await Promise.all([ie(o,a),a]);if(!t&&O.has("wikiEditor"))try{if("function"==typeof mw.addWikiEditor)mw.addWikiEditor(e);else{const{wikiEditor:{modules:{dialogs:{config:i}}}}=$;e.wikiEditor("addModule",{...$.wikiEditor.modules.toolbar.config.getDefaultConfig(),...i.getDefaultConfig()}),i.replaceIcons(e)}}catch(e){O.delete("wikiEditor"),mw.notify("WikiEditor工具栏加载失败。",{type:"error"}),console.error(e)}"mediawiki"===o&&s.tags.html?(s.tagModes.html="htmlmixed",await X("html")):"widget"!==o||CodeMirror.mimeModes.widget||CodeMirror.defineMIME("widget",{name:"htmlmixed",tags:{noinclude:[[null,null,"mediawiki"]]}});const r=e.height();J&&J.toTextArea();const l=t||"json"===u;if(J=CodeMirror.fromTextArea(e[0],$.extend({inputStyle:"contenteditable",lineNumbers:!/Android\b/.test(navigator.userAgent),lineWrapping:!0,mode:o,mwConfig:s,json:l},Object.fromEntries(v.map((({option:e,addon:i=e,modes:t,complex:n=(e=>!t||t.includes(e))})=>{const a=Array.isArray(i)?i[0]:i;return[e,O.has(a)&&n(o,l)]}))),"mediawiki"===o?{extraKeys:O.has("escape")&&(T(CodeMirror)?A:L)}:{indentUnit:O.has("indentWithSpace")?E:4,indentWithTabs:!O.has("indentWithSpace")})),J.setSize(null,r),J.getWrapperElement().id="Wikiplus-CodeMirror",$.fn.textSelection&&e.textSelection("register",te),O.has("wikiEditor")){const i=e.data("wikiEditorContext"),{keyMap:t}=CodeMirror,o=()=>{$.wikiEditor.modules.dialogs.api.openDialog(i,"search-and-replace")};J.addKeyMap(t.default===t.pcDefault?{"Ctrl-F":o}:{"Cmd-F":o})}if(P(J,o),$("#Wikiplus-Quickedit-Jump").children("a").attr("href","#Wikiplus-CodeMirror"),!t){const e=("object"==typeof window.Wikiplus?window.Wikiplus:{getSetting(e){const t=i.getObject("Wikiplus_Settings");return t&&t[e]}}).getSetting("esc_to_exit_quickedit"),t=()=>{$("#Wikiplus-Quickedit-Submit").triggerHandler("click")},o=()=>{$("#Wikiplus-Quickedit-MinorEdit").click(),$("#Wikiplus-Quickedit-Submit").triggerHandler("click")};J.addKeyMap($.extend(T(CodeMirror)?{"Ctrl-S":t,"Shift-Ctrl-S":o}:{"Cmd-S":t,"Shift-Cmd-S":o},!0===e||"true"===e?{Esc(){$("#Wikiplus-Quickedit-Back").triggerHandler("click")}}:{}))}J.refresh(),mw.hook("wiki-codemirror").fire(J)},{body:ne}=document;new MutationObserver((e=>{const i=$(t(e.map((({addedNodes:e})=>[...e])))).find("#Wikiplus-Quickedit, #Wikiplus-Setting-Input");0!==i.length&&oe(i,"Wikiplus-Setting-Input"===i.attr("id"))})).observe(ne,{childList:!0}),$(ne).on("keydown.wphl",".ui-dialog",(function(e){if("Escape"===e.key){const i=$(this).children(".ui-dialog-content").data("context");i&&i.$textarea&&"Wikiplus-Quickedit"===i.$textarea.attr("id")&&e.stopPropagation()}}));const ae=document.querySelector("#wphl-style")||mw.loader.addStyleTag("#Wikiplus-CodeMirror{border:1px solid #c8ccd1;line-height:1.3;clear:both;-moz-user-select:auto;-webkit-user-select:auto;user-select:auto}#Wikiplus-CodeMirror .CodeMirror-gutter-wrapper{-moz-user-select:none;-webkit-user-select:none;user-select:none}div.Wikiplus-InterBox{font-size:14px;z-index:100}.skin-minerva .Wikiplus-InterBox{font-size:16px}.cm-trailingspace{text-decoration:underline wavy red}div.CodeMirror span.CodeMirror-matchingbracket{box-shadow:0 0 0 2px #9aef98}div.CodeMirror span.CodeMirror-nonmatchingbracket{box-shadow:0 0 0 2px #eace64}#Wikiplus-highlight-dialog .oo-ui-messageDialog-title{margin-bottom:0.28571429em}#Wikiplus-highlight-dialog .oo-ui-flaggedElement-notice{font-weight:normal;margin:0}.CodeMirror-contextmenu .cm-mw-template-name{cursor:pointer}.skin-moeskin #ca-more-actions li>a{display:inline-block;padding:0.4rem 0.8rem;line-height:1.5}");ae.id="wphl-style";const{get:se=(e=>e.value),set:re=((e,i)=>{e.value=i})}=$.valHooks.textarea||{},le=e=>"Wikiplus-Quickedit"===e.id||"Wikiplus-Setting-Input"===e.id;let de,ce,me,ge,pe,ue,we,he;$.valHooks.textarea={get:e=>le(e)&&J?J.getValue():se(e),set(e,i){le(e)&&J?J.setValue(i):re(e,i)}},await B;const ke=(e=[...O])=>{he.toggle(e.includes("indentWithSpace"))},fe=$(mw.util.addPortletLink({minerva:"page-actions-overflow",citizen:"p-actions",moeskin:"ca-more-actions"}[f]||"p-cactions","#",n("portlet"),"wphl-settings")).click((async e=>{if(e.preventDefault(),de)ce.setValue([...O]),ue.setValue(E);else{await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),de=new OO.ui.MessageDialog({id:"Wikiplus-highlight-dialog"});const e=new OO.ui.WindowManager;e.$element.appendTo(ne),e.addWindows([de]),ce=new OO.ui.CheckboxMultiselectInputWidget({options:[...v.map((({option:e,addon:i=e})=>{const t=Array.isArray(i)?i[0]:i;return{data:t,label:a(`addon-${t.toLowerCase()}`)}})),...["wikiEditor","escape","contextmenu","lint","indentWithSpace","otherEditors"].map((e=>({data:e,label:a(`addon-${e.toLowerCase()}`)})))],value:[...O]}).on("change",ke);const{checkboxMultiselectWidget:i}=ce;me=i.findItemFromData("search"),ge=i.findItemFromData("wikiEditor"),pe=i.findItemFromData("lint"),ue=new OO.ui.NumberInputWidget({min:0,value:E}),we=new OO.ui.FieldLayout(ce,{label:n("addon-label"),notices:[n("addon-notice")],align:"top"}),he=new OO.ui.FieldLayout(ue,{label:n("addon-indent")}),ke(),Object.assign(mw.libs.wphl,{widget:ce,indentWidget:ue})}const t="object"==typeof window.Wikiplus||"object"==typeof window.Pages;me.setDisabled(!t),ge.setDisabled(!t||!mw.loader.getState("ext.wikiEditor")),pe.setDisabled(!t);const o=await de.open({title:n("addon-title"),message:we.$element.add(he.$element).add($("<p>",{html:n("feedback")})),actions:[{action:"reject",label:mw.msg("ooui-dialog-message-reject")},{action:"accept",label:mw.msg("ooui-dialog-message-accept"),flags:"progressive"}],size:"en"===F||"minerva"===f?"medium":"small"}).closing;if(we.$element.detach(),he.$element.detach(),"object"==typeof o&&"accept"===o.action){const e=ce.getValue();O.clear();for(const i of e)O.add(i);E=Number(ue.getValue()),i.setObject("Wikiplus-highlight-addons",e),i.setObject("Wikiplus-highlight-indent",E)}}));"minerva"===f&&fe.find(".mw-ui-icon").addClass("mw-ui-icon-minerva-settings"),"function"==typeof N&&N().find("#wphl-settings-notify").click((e=>{e.preventDefault(),$("#wphl-settings").triggerHandler("click")}));const be=async e=>{if(!O.has("otherEditors"))return;let i=e.getOption("mode");i="text/mediawiki"===i?"mediawiki":i;const t=R(CodeMirror,!0),o=e.getOption("json");await K(t);for(const{option:t,addon:n=t,modes:a,complex:s=(e=>!a||a.includes(e))}of v.filter((({only:e})=>!e))){const a=Array.isArray(n)?n[0]:n;void 0===e.getOption(t)&&O.has(a)&&e.setOption(t,s(i,o))}"mediawiki"===i&&O.has("escape")?e.addKeyMap(T(CodeMirror)?A:L,!0):"mediawiki"!==i&&O.has("indentWithSpace")&&(e.setOption("indentUnit",E),e.setOption("indentWithTabs",!1)),P(e,i)};mw.hook("InPageEdit.quickEdit.codemirror").add((({cm:e})=>be(e))),mw.hook("inspector").add((e=>be(e))),mw.hook("wiki-codemirror").add((e=>{e.getTextArea&&le(e.getTextArea())||be(e)})),mw.libs.wphl={version:e,options:v,addons:O,i18n:D,i18nLang:F,wphlStyle:ae,$portlet:fe,USING_LOCAL:b,MODE_LIST:M,ADDON_LIST:W,msg:n,htmlMsg:a,escapeHTML:I,handleContextMenu:P,setI18N:V,getAddonScript:R,updateCachedConfig:Y,getMwConfig:ie,renderEditor:oe,handleOtherEditors:be}})();
//# sourceMappingURL=/sm/60e900f37b4eaa8a8c77de9dd79b449f981f76b35ec1f5d70380fc6d8c40e68c.map
