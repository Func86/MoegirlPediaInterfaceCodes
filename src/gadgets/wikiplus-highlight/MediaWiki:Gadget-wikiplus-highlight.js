/**
 * Generated by scripts/prefetch.js
 * Options:
 *     name: "wikiplus-highlight"
 *     url: "https://cdn.jsdelivr.net/npm/wikiplus-highlight"
 *     file: "src/gadgets/wikiplus-highlight/MediaWiki:Gadget-wikiplus-highlight.js"
 */
/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/wikiplus-highlight@2.40.0/main.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
/**
 * @name Wikiplus-highlight Wikiplus编辑器的CodeMirror语法高亮扩展
 * @author Bhsd <https://github.com/bhsd-harry>
 * @author 机智的小鱼君 <https://github.com/Dragon-Fish>
 * @license GPL-3.0
 */
(async()=>{"use strict";if(mw.libs.wphl)return;mw.libs.wphl={};const e="2.40",i="object"==typeof mw.storage&&"function"==typeof mw.storage.getObject?mw.storage:{getObject(e){const i=localStorage.getItem(e);if(!1===i)return!1;try{return JSON.parse(i)}catch(e){return null}},setObject(e,i){try{return localStorage.setItem(e,JSON.stringify(i))}catch(e){return!1}}};Object.fromEntries=Object.fromEntries||(e=>{const i={};for(const[t,o]of e)i[t]=o;return i});const t=(e="2.40")=>e.split(".").map(Number),o=(e,...i)=>mw.msg(`wphl-${e}`,...i),n=(...e)=>$($.parseHTML(o(...e))),a=(...e)=>()=>{const i=$("<p>",{html:o(...e)});return mw.notify(i,{type:"success",autoHideSeconds:"long",tag:"wikiplus-highlight"}),i},s=t().slice(0,2).join("."),r="//fastly.jsdelivr.net",l="npm/codemirror@5.65.3",d="gh/bhsd-harry/codemirror-mediawiki@1.1.6",c=`npm/wikiplus-highlight@${s}`,{config:{values:{wgPageName:m,wgNamespaceNumber:g,wgPageContentModel:p,wgServerName:u,wgScriptPath:w,wgUserLanguage:h,skin:k}}}=mw,f=null!==mw.loader.getState("ext.CodeMirror"),b=i.getObject("InPageEditMwConfig")||{},x=`${u}${w}`,y=b[x]||{},C=!(y.time>Date.now()-2592e6),j={css:"css","sanitized-css":"css",javascript:"javascript",json:"javascript",wikitext:"mediawiki"},S=f?{lib:"ext.CodeMirror.lib",css:"ext.CodeMirror.lib.mode.css",javascript:"ext.CodeMirror.lib.mode.javascript",lua:`${l}/mode/lua/lua.min.js`,mediawiki:C?"ext.CodeMirror.data":[],htmlmixed:"ext.CodeMirror.lib.mode.htmlmixed",xml:[]}:{lib:`${l}/lib/codemirror.min.js`,css:`${l}/mode/css/css.min.js`,javascript:`${l}/mode/javascript/javascript.min.js`,lua:`${l}/mode/lua/lua.min.js`,mediawiki:[],htmlmixed:`${l}/mode/htmlmixed/htmlmixed.min.js`,xml:`${l}/mode/xml/xml.min.js`},M={searchcursor:`${l}/addon/search/searchcursor.min.js`,search:`${c}/search.min.js`,markSelection:`${l}/addon/selection/mark-selection.min.js`,activeLine:`${l}/addon/selection/active-line.min.js`,trailingspace:`${l}/addon/edit/trailingspace.min.js`,matchBrackets:`${l}/addon/edit/matchbrackets.min.js`,closeBrackets:`${l}/addon/edit/closebrackets.min.js`,matchTags:`${c}/matchtags.min.js`,fold:`${c}/fold.min.js`,wikiEditor:"ext.wikiEditor",contextmenu:"mediawiki.Title",lint:`${l}/addon/lint/lint.min.js`,annotateScrollbar:`${l}/addon/scroll/annotatescrollbar.min.js`,parser:"gh/bhsd-harry/wikiparser-node@0.6.21-b/bundle/bundle.min.js",lintWikitext:`${c}/lint.min.js`},W=[{option:"styleSelectedText",addon:"search",download:"markSelection",only:!0,complex:()=>!v.has("wikiEditor")},{option:"styleActiveLine",addon:"activeLine"},{option:"showTrailingSpace",addon:"trailingspace"},{option:"matchBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||{bracketRegex:/[{}[\]]/}},{option:"autoCloseBrackets",addon:"closeBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||'()[]{}""'},{option:"matchTags",addon:["matchTags","fold"],modes:new Set(["mediawiki","widget"])},{option:"fold",modes:new Set(["mediawiki","widget"])}],v=new Set(i.getObject("Wikiplus-highlight-addons")||["search"]);let O=i.getObject("Wikiplus-highlight-indent")||4;const E={'"':"quot","'":"apos","<":"lt",">":"gt","&":"amp"," ":"nbsp"},_=e=>i=>{i.replaceSelection(i.getSelection().split("\n").map(e).join("\n"),"around")},z=_((e=>[...e].map((e=>{if(e in E)return`&${E[e]};`;const i=e.codePointAt();return i<256?`&#${i};`:`&#x${i.toString(16)};`})).join(""))),I=({keyMap:e})=>e.default===e.pcDefault,T={"Ctrl-/":z,"Ctrl-\\":_(encodeURIComponent)},A={"Cmd-/":z,"Cmd-\\":_(encodeURIComponent)},P=(e,i)=>{if("mediawiki"!==i&&"widget"!==i||!v.has("contextmenu"))return;const t=$(e.getWrapperElement()).addClass("CodeMirror-contextmenu"),{functionSynonyms:[o]}=mw.config.get("extCodeMirrorConfig")||{functionSynonyms:[{invoke:"invoke","调用":"invoke",widget:"widget","小工具":"widget"}]},n=e=>new Set(Object.keys(o).filter((i=>o[i]===e)).map((e=>e.startsWith("#")?e:`#${e}`))),a=n("invoke"),s=n("widget");t.contextmenu((({pageX:i,pageY:t})=>{const o=e.coordsChar({left:i,top:t}),{line:n,ch:r}=o,l=e.getTokenTypeAt(o);if(!/\bmw-(?:template-name|parserfunction)\b/.test(l))return;const d=e.getLineTokens(n);for(let e=d.length-1;e>0;e--){const{type:i,end:t,string:o}=d[e];d[e-1].type===i&&(d[e-1].end=t,d[e-1].string+=o,d.splice(e,1))}const c=d.findIndex((({start:e,end:i})=>e<r&&i>=r)),m=d[c].string.replace(/\u200E/g,"").replace(/_/g," ").trim();if(/\bmw-template-name\b/.test(l)){const e=new mw.Title(m);return 0!==e.namespace||m.startsWith(":")?open(e.getUrl(),"_blank"):open(mw.util.getUrl(`Template:${m}`),"_blank"),!1}if(c<2||!/\bmw-parserfunction-delimiter\b/.test(d[c-1].type)||!/\bmw-parserfunction-name\b/.test(d[c-2].type))return;const g=d[c-2].string.trim().toLowerCase();if(a.has(g))open(mw.util.getUrl(`Module:${m}`),"_blank");else{if(!s.has(g))return;open(mw.util.getUrl(`Widget:${m}`,{action:"edit"}),"_blank")}return!1}))},L=i.getObject("Wikiplus-highlight-i18n")||{};let D;L["wphl-version"]?((e,i)=>{const[o,n]=t(e),[a,s]=t(i);return o<a||o===a&&n<s})(L["wphl-version"],e)&&(D=a("welcome-upgrade",e,0)):D=a("welcome");const N={zh:"zh-hans","zh-hans":"zh-hans","zh-cn":"zh-hans","zh-my":"zh-hans","zh-sg":"zh-hans","zh-hant":"zh-hant","zh-tw":"zh-hant","zh-hk":"zh-hant","zh-mo":"zh-hant",ka:"ka"}[h]||"en",F=`${r}/${c}/i18n/${N}.json`,H=L["wphl-version"]===s,U=async()=>{H&&L["wphl-lang"]===N||(Object.assign(L,await $.ajax(`${F}`,{dataType:"json",cache:!0})),i.setObject("Wikiplus-highlight-i18n",L)),mw.messages.set(L)},V=Promise.all([mw.loader.using("mediawiki.util"),U()]),B=e=>e.length>0?mw.loader.using(e):Promise.resolve(),Q=e=>e.length>0?$.ajax(`${r}/${e.length>1?"combine/":""}${e.join()}`,{dataType:"script",cache:!0}):Promise.resolve(),q=async(e,i)=>{const t=e.filter((e=>!e.includes("/"))),o=e.filter((e=>e.includes("/")));return!0===i?(await B(t),Q(o)):!1===i?(await Q(o),B(t)):Promise.all([B(t),Q(o)])};let K;const J=(e,i=!1)=>{const t=[];for(const{option:o,addon:n=o,download:a=(Array.isArray(n)?o:n),only:s}of W)s&&i||o in e.optionHandlers||!R(n,v)||t.push(M[a]);return t},R=(e,i)=>Array.isArray(e)?e.some((e=>i.has(e))):i.has(e),G=e=>{let i=[];const t="function"==typeof window.CodeMirror,o=t?window.CodeMirror:{modes:{},prototype:{},commands:{},optionHandlers:{},helpers:{}};if(t||(i.push(S.lib),f||mw.loader.load(`${r}/${l}/lib/codemirror.min.css`,"text/css")),"mediawiki"===e&&y.config&&y.config.tags.html&&(e="html"),"mediawiki"!==e&&"widget"!==e||o.modes.mediawiki||(mw.loader.load(`${r}/${d}/mediawiki.min.css`,"text/css"),i.push(`${d}/mediawiki.min.js`)),"widget"===e||"html"===e)for(const e of["css","javascript","mediawiki","htmlmixed","xml"])o.modes[e]||(i=i.concat(S[e]));else i=i.concat(S[e]);if(o.prototype.getSearchCursor||!v.has("search")||v.has("wikiEditor")||i.push(M.searchcursor),!o.prototype.annotateScrollbar&&"mediawiki"===e&&v.has("lint")&&i.push(M.annotateScrollbar),o.commands.findForward||!v.has("search")||v.has("wikiEditor")||i.push(M.search),!window.Parser&&"mediawiki"===e&&v.has("lint")&&i.push(M.parser),!o.optionHandlers.lint&&"mediawiki"===e&&v.has("lint")&&(mw.loader.load(`${r}/${l}/addon/lint/lint.min.css`,"text/css"),i.push(M.lint)),o.helpers.lint&&o.helpers.lint.mediawiki||"mediawiki"!==e||!v.has("lint")||i.push(M.lintWikitext),v.has("wikiEditor")){const e=mw.loader.getState("ext.wikiEditor");e?"ready"!==e&&i.push(M.wikiEditor):v.delete("wikiEditor")}return"ready"!==mw.loader.getState("mediawiki.Title")&&v.has("contextmenu")&&i.push(M.contextmenu),i.push(...J(o)),q(i,t?void 0:f)},X=e=>{b[x]={config:e,time:Date.now()},i.setObject("InPageEditMwConfig",b)},Y=e=>e.flatMap((({aliases:e,name:i})=>e.map((e=>({alias:e,name:i}))))),Z=e=>Object.fromEntries(e.map((({alias:e,name:i})=>[e.replace(/:$/,""),i]))),ee=e=>{const i=["indicator","poem","ref","tabs","tab","poll"];for(const t of i)e.tags[t]&&(e.tagModes[t]="text/mediawiki")},ie=async(e,i)=>{if("mediawiki"!==e&&"widget"!==e)return;f&&C&&await i;let t=mw.config.get("extCodeMirrorConfig");if(t||C||!H||(({config:t}=y),ee(t),mw.config.set("extCodeMirrorConfig",t)),t&&t.redirect&&t.img)return t;const{query:{magicwords:o,extensiontags:n,functionhooks:a,variables:s}}=await(new mw.Api).get({meta:"siteinfo",siprop:t?"magicwords":"magicwords|extensiontags|functionhooks|variables",formatversion:2}),r=new Set(["msg","raw","msgnw","subst","safesubst"]);if(t){const{functionSynonyms:[e]}=t;if(!e.subst){const i=Y(o.filter((({name:e})=>r.has(e))));for(const{alias:t,name:o}of i)e[t.replace(/:$/,"")]=o}}else{t={tagModes:{pre:"mw-tag-pre",nowiki:"mw-tag-nowiki",ref:"text/mediawiki"},tags:Object.fromEntries(n.map((e=>[e.slice(1,-1),!0]))),urlProtocols:mw.config.get("wgUrlProtocols")};const e=new Set([...a,...s,...r]),i=o.filter((({name:i,aliases:t})=>t.some((e=>/^__.+__$/.test(e)))||e.has(i))),l=Y(i.filter((e=>e["case-sensitive"]))),d=Y(i.filter((e=>!e["case-sensitive"]))).map((({alias:e,name:i})=>({alias:e.toLowerCase(),name:i})));t.doubleUnderscore=[Z(d.filter((({alias:e})=>/^__.+__$/.test(e)))),Z(l.filter((({alias:e})=>/^__.+__$/.test(e))))],t.functionSynonyms=[Z(d.filter((({alias:e})=>!/^__.+__|^#$/.test(e)))),Z(l.filter((({alias:e})=>!/^__.+__|^#$/.test(e))))]}return t.redirect=o.find((({name:e})=>"redirect"===e)).aliases,t.img=Z(Y(o.filter((({name:e})=>e.startsWith("img_"))))),ee(t),mw.config.set("extCodeMirrorConfig",t),X(t),t},te={getContents:()=>K.getValue(),setContents(e){return K.setValue(e),this},getSelection:()=>K.getSelection(),setSelection(e){return K.setSelection(K.posFromIndex(e.start),"end"in e?K.posFromIndex(e.end):void 0),K.focus(),this},replaceSelection(e){return K.replaceSelection(e),this},getCaretPosition(e){const i=K.indexFromPos(K.getCursor("from")),t=K.indexFromPos(K.getCursor("to"));return e.startAndEnd?[i,t]:i},scrollToCaretPosition(){return K.scrollIntoView(),this}},oe=async(e,t)=>{const n=t?"javascript":await(async()=>{if(m.endsWith("/doc"))return"mediawiki";if(274!==g&&828!==g)return j[p];const e=274===g?"Widget":"Lua";return await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),await OO.ui.confirm(o("contentmodel"),{actions:[{label:e},{label:"Wikitext",action:"accept"}]})?"mediawiki":e.toLowerCase()})(),a=G(n),[s]=await Promise.all([ie(n,a),a]);if(!t&&v.has("wikiEditor"))try{if("function"==typeof mw.addWikiEditor)mw.addWikiEditor(e);else{const{wikiEditor:{modules:{dialogs:{config:i}}}}=$;e.wikiEditor("addModule",{...$.wikiEditor.modules.toolbar.config.getDefaultConfig(),...i.getDefaultConfig()}),i.replaceIcons(e)}}catch(e){v.delete("wikiEditor"),mw.notify("WikiEditor工具栏加载失败。",{type:"error"}),console.error(e)}"mediawiki"===n&&s.tags.html?(s.tagModes.html="htmlmixed",await G("html")):"widget"!==n||CodeMirror.mimeModes.widget||CodeMirror.defineMIME("widget",{name:"htmlmixed",tags:{noinclude:[[null,null,"mediawiki"]]}});const r=e.height();K&&K.toTextArea();const l=t||"json"===p;if(K=CodeMirror.fromTextArea(e[0],$.extend({inputStyle:"contenteditable",lineNumbers:!/Android\b/.test(navigator.userAgent),lineWrapping:!0,mode:n,mwConfig:s,json:l},Object.fromEntries(W.map((({option:e,addon:i=e,modes:t,complex:o=(e=>!t||t.has(e))})=>{const a=Array.isArray(i)?i[0]:i;return[e,v.has(a)&&o(n,l)]}))),"mediawiki"===n?{extraKeys:v.has("escape")&&(I(CodeMirror)?T:A)}:{indentUnit:v.has("indentWithSpace")?O:4,indentWithTabs:!v.has("indentWithSpace")})),K.setSize(null,r),K.getWrapperElement().id="Wikiplus-CodeMirror",$.fn.textSelection&&e.textSelection("register",te),v.has("wikiEditor")){const i=e.data("wikiEditorContext"),{keyMap:t}=CodeMirror,o=()=>{$.wikiEditor.modules.dialogs.api.openDialog(i,"search-and-replace")};K.addKeyMap(t.default===t.pcDefault?{"Ctrl-F":o}:{"Cmd-F":o})}if(P(K,n),$("#Wikiplus-Quickedit-Jump").children("a").attr("href","#Wikiplus-CodeMirror"),!t){const e=("object"==typeof window.Wikiplus?window.Wikiplus:{getSetting(e){const t=i.getObject("Wikiplus_Settings");return t&&t[e]}}).getSetting("esc_to_exit_quickedit"),t=()=>{$("#Wikiplus-Quickedit-Submit").triggerHandler("click")},o=()=>{$("#Wikiplus-Quickedit-MinorEdit").click(),$("#Wikiplus-Quickedit-Submit").triggerHandler("click")};K.addKeyMap($.extend(I(CodeMirror)?{"Ctrl-S":t,"Shift-Ctrl-S":o}:{"Cmd-S":t,"Shift-Cmd-S":o},!0===e||"true"===e?{Esc(){$("#Wikiplus-Quickedit-Back").triggerHandler("click")}}:{}))}K.refresh(),mw.hook("wiki-codemirror").fire(K)},{body:ne}=document;new MutationObserver((e=>{const i=$(e.flatMap((({addedNodes:e})=>[...e]))).find("#Wikiplus-Quickedit, #Wikiplus-Setting-Input");i.length>0&&oe(i,"Wikiplus-Setting-Input"===i.attr("id"))})).observe(ne,{childList:!0}),$(ne).on("keydown.wphl",".ui-dialog",(function(e){if("Escape"===e.key){const i=$(this).children(".ui-dialog-content").data("context");i&&i.$textarea&&"Wikiplus-Quickedit"===i.$textarea.attr("id")&&e.stopPropagation()}}));const ae=document.querySelector("#wphl-style")||mw.loader.addStyleTag("#Wikiplus-CodeMirror{border:1px solid #c8ccd1;line-height:1.3;clear:both;-moz-user-select:auto;-webkit-user-select:auto;user-select:auto}#Wikiplus-CodeMirror .CodeMirror-gutter-wrapper{-moz-user-select:none;-webkit-user-select:none;user-select:none}div.Wikiplus-InterBox{font-size:14px;z-index:100}.skin-minerva .Wikiplus-InterBox{font-size:16px}.cm-trailingspace{text-decoration:underline wavy red}div.CodeMirror span.CodeMirror-matchingbracket{box-shadow:0 0 0 2px #9aef98}div.CodeMirror span.CodeMirror-nonmatchingbracket{box-shadow:0 0 0 2px #eace64}#Wikiplus-highlight-dialog .oo-ui-messageDialog-title{margin-bottom:0.28571429em}#Wikiplus-highlight-dialog .oo-ui-flaggedElement-notice{font-weight:normal;margin:0}.CodeMirror-contextmenu .cm-mw-template-name{cursor:pointer}.skin-moeskin #ca-more-actions li>a{display:inline-block;padding:0.4rem 0.8rem;line-height:1.5}.skin-moeskin .oo-ui-windowManager-modal>.oo-ui-dialog{z-index:101}");ae.id="wphl-style";const{get:se=(e=>e.value),set:re=((e,i)=>{e.value=i})}=$.valHooks.textarea||{},le=e=>"Wikiplus-Quickedit"===e.id||"Wikiplus-Setting-Input"===e.id;let de,ce,me,ge,pe,ue,we,he;$.valHooks.textarea={get:e=>le(e)&&K?K.getValue():se(e),set(e,i){le(e)&&K?K.setValue(i):re(e,i)}},await V;const ke=(e=[...v])=>{he.toggle(e.includes("indentWithSpace"))},fe=$(mw.util.addPortletLink({minerva:"page-actions-overflow",citizen:"p-actions",moeskin:"ca-more-actions"}[k]||"p-cactions","#",o("portlet"),"wphl-settings")).click((async e=>{if(e.preventDefault(),de)ce.setValue([...v]),ue.setValue(O);else{await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),de=new OO.ui.MessageDialog({id:"Wikiplus-highlight-dialog"});const e=new OO.ui.WindowManager;e.$element.appendTo(ne),e.addWindows([de]),ce=new OO.ui.CheckboxMultiselectInputWidget({options:[...W.map((({option:e,addon:i=e})=>{const t=Array.isArray(i)?i[0]:i;return{data:t,label:n(`addon-${t.toLowerCase()}`)}})),...["wikiEditor","escape","contextmenu","lint","indentWithSpace","otherEditors"].map((e=>({data:e,label:n(`addon-${e.toLowerCase()}`)})))],value:[...v]}).on("change",ke);const{checkboxMultiselectWidget:i}=ce;me=i.findItemFromData("search"),ge=i.findItemFromData("wikiEditor"),pe=i.findItemFromData("lint"),ue=new OO.ui.NumberInputWidget({min:0,value:O}),we=new OO.ui.FieldLayout(ce,{label:o("addon-label"),notices:[o("addon-notice")],align:"top"}),he=new OO.ui.FieldLayout(ue,{label:o("addon-indent")}),ke(),Object.assign(mw.libs.wphl,{widget:ce,indentWidget:ue})}const t="object"==typeof window.Wikiplus||"object"==typeof window.Pages;me.setDisabled(!t),ge.setDisabled(!t||!mw.loader.getState("ext.wikiEditor")),pe.setDisabled(!t);const a=await de.open({title:o("addon-title"),message:we.$element.add(he.$element).add($("<p>",{html:o("feedback")})),actions:[{action:"reject",label:mw.msg("ooui-dialog-message-reject")},{action:"accept",label:mw.msg("ooui-dialog-message-accept"),flags:"progressive"}],size:"en"===N||"minerva"===k?"medium":"small"}).closing;if(we.$element.detach(),he.$element.detach(),"object"==typeof a&&"accept"===a.action){const e=ce.getValue();v.clear();for(const i of e)v.add(i);O=Number(ue.getValue()),i.setObject("Wikiplus-highlight-addons",e),i.setObject("Wikiplus-highlight-indent",O)}}));"minerva"===k&&fe.find(".mw-ui-icon").addClass("mw-ui-icon-minerva-settings"),"function"==typeof D&&D().find("#wphl-settings-notify").click((e=>{e.preventDefault(),$("#wphl-settings").triggerHandler("click")}));const be=async e=>{if(!v.has("otherEditors"))return;let i=e.getOption("mode");i="text/mediawiki"===i?"mediawiki":i;const t=J(CodeMirror,!0),o=e.getOption("json");await q(t);for(const{option:t,addon:n=t,modes:a,complex:s=(e=>!a||a.has(e))}of W.filter((({only:e})=>!e))){const a=Array.isArray(n)?n[0]:n;void 0===e.getOption(t)&&v.has(a)&&e.setOption(t,s(i,o))}"mediawiki"===i&&v.has("escape")?e.addKeyMap(I(CodeMirror)?T:A,!0):"mediawiki"!==i&&v.has("indentWithSpace")&&(e.setOption("indentUnit",O),e.setOption("indentWithTabs",!1)),P(e,i)};mw.hook("InPageEdit.quickEdit.codemirror").add((({cm:e})=>be(e))),mw.hook("inspector").add((e=>be(e))),mw.hook("wiki-codemirror").add((e=>{e.getTextArea&&le(e.getTextArea())||be(e)})),mw.libs.wphl={version:e,options:W,addons:v,i18n:L,i18nLang:N,wphlStyle:ae,$portlet:fe,USING_LOCAL:f,MODE_LIST:S,ADDON_LIST:M,msg:o,htmlMsg:n,escapeHTML:z,handleContextMenu:P,setI18N:U,getAddonScript:J,updateCachedConfig:X,getMwConfig:ie,renderEditor:oe,handleOtherEditors:be,isPc:I}})();
//# sourceMappingURL=/sm/165e7d640a533b876f58ed7209558014000728a059fba9c4cf466c77f41681e1.map
