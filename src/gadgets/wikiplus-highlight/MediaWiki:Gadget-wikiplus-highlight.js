/**
 * Generated by scripts/prefetch.js
 * Options:
 *     name: "wikiplus-highlight"
 *     url: "https://cdn.jsdelivr.net/npm/wikiplus-highlight"
 *     file: "src/gadgets/wikiplus-highlight/MediaWiki:Gadget-wikiplus-highlight.js"
 */
/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/wikiplus-highlight@2.44.2/main.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
/**
 * @name Wikiplus-highlight Wikiplus编辑器的CodeMirror语法高亮扩展
 * @author Bhsd <https://github.com/bhsd-harry>
 * @author 机智的小鱼君 <https://github.com/Dragon-Fish>
 * @license GPL-3.0
 */
(async()=>{"use strict";if(mw.libs.wphl&&mw.libs.wphl.version)return;mw.libs.wphl=mw.libs.wphl||{};const e="2.44.2",i="object"==typeof mw.storage&&"function"==typeof mw.storage.getObject?mw.storage:{getObject(e){const i=localStorage.getItem(e);if(!1===i)return!1;try{return JSON.parse(i)}catch(e){return null}},setObject(e,i){try{return localStorage.setItem(e,JSON.stringify(i))}catch(e){return!1}}};Object.fromEntries=Object.fromEntries||(e=>{const i={};for(const[t,o]of e)i[t]=o;return i});const t=(i=e)=>i.split(".").map(Number),o=(e,...i)=>mw.msg(`wphl-${e}`,...i),n=(...e)=>$($.parseHTML(o(...e))),a=(...e)=>()=>{const i=$("<p>",{html:o(...e)});return mw.notify(i,{type:"success",autoHideSeconds:"long",tag:"wikiplus-highlight"}),i},s=t().slice(0,2).join("."),r="//fastly.jsdelivr.net",l="npm/codemirror@5.65.3",d="gh/bhsd-harry/codemirror-mediawiki@1.1.6",c=`npm/wikiplus-highlight@${s}`,{config:{values:{wgPageName:m,wgNamespaceNumber:g,wgPageContentModel:p,wgServerName:u,wgScriptPath:w,wgUserLanguage:h,skin:k}}}=mw,f=null!==mw.loader.getState("ext.CodeMirror"),b=i.getObject("InPageEditMwConfig")||{},x=`${u}${w}`,y=b[x]||{},j=!(y.time>Date.now()-2592e6),C={css:"css","sanitized-css":"css",javascript:"javascript",json:"javascript",wikitext:"mediawiki"},S=f?{lib:"ext.CodeMirror.lib",css:"ext.CodeMirror.lib.mode.css",javascript:"ext.CodeMirror.lib.mode.javascript",lua:`${l}/mode/lua/lua.min.js`,mediawiki:j?"ext.CodeMirror.data":[],htmlmixed:"ext.CodeMirror.lib.mode.htmlmixed",xml:[]}:{lib:`${l}/lib/codemirror.min.js`,css:`${l}/mode/css/css.min.js`,javascript:`${l}/mode/javascript/javascript.min.js`,lua:`${l}/mode/lua/lua.min.js`,mediawiki:[],htmlmixed:`${l}/mode/htmlmixed/htmlmixed.min.js`,xml:`${l}/mode/xml/xml.min.js`},M={searchcursor:`${l}/addon/search/searchcursor.min.js`,search:`${c}/search.min.js`,markSelection:`${l}/addon/selection/mark-selection.min.js`,activeLine:`${l}/addon/selection/active-line.min.js`,trailingspace:`${l}/addon/edit/trailingspace.min.js`,matchBrackets:`${l}/addon/edit/matchbrackets.min.js`,closeBrackets:`${l}/addon/edit/closebrackets.min.js`,matchTags:`${c}/matchtags.min.js`,fold:`${c}/fold.min.js`,wikiEditor:"ext.wikiEditor",contextmenu:"mediawiki.Title",lint:`${l}/addon/lint/lint.min.js`,annotateScrollbar:`${l}/addon/scroll/annotatescrollbar.min.js`,parser:"gh/bhsd-harry/wikiparser-node@0.6.28-b/extensions/editor.min.js",lintWikitext:`${c}/lint.min.js`},v=[{option:"styleSelectedText",addon:"search",download:"markSelection",only:!0,complex:()=>!W.has("wikiEditor")},{option:"styleActiveLine",addon:"activeLine"},{option:"showTrailingSpace",addon:"trailingspace"},{option:"matchBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||{bracketRegex:/[{}[\]]/}},{option:"autoCloseBrackets",addon:"closeBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||'()[]{}""'},{option:"matchTags",addon:["matchTags","fold"],modes:new Set(["mediawiki","widget"])},{option:"fold",modes:new Set(["mediawiki","widget"])}],W=new Set(i.getObject("Wikiplus-highlight-addons")||["search"]);let O=i.getObject("Wikiplus-highlight-indent")||4;const E={'"':"quot","'":"apos","<":"lt",">":"gt","&":"amp"," ":"nbsp"},_=e=>i=>{i.replaceSelection(i.getSelection().split("\n").map(e).join("\n"),"around")},z=_((e=>[...e].map((e=>{if(e in E)return`&${E[e]};`;const i=e.codePointAt();return i<256?`&#${i};`:`&#x${i.toString(16)};`})).join(""))),I=_((e=>{if(e.includes("%"))try{return decodeURIComponent(e)}catch(e){}return encodeURIComponent(e)})),T=({keyMap:e})=>e.default===e.pcDefault,A={"Ctrl-/":z,"Ctrl-\\":I},L={"Cmd-/":z,"Cmd-\\":I},P=(e,i)=>{if("mediawiki"!==i&&"widget"!==i||!W.has("contextmenu"))return;const t=$(e.getWrapperElement()).addClass("CodeMirror-contextmenu"),{functionSynonyms:[o]}=mw.config.get("extCodeMirrorConfig")||{functionSynonyms:[{invoke:"invoke","调用":"invoke",widget:"widget","小工具":"widget"}]},n=e=>new Set(Object.keys(o).filter((i=>o[i]===e)).map((e=>e.startsWith("#")?e:`#${e}`))),a=n("invoke"),s=n("widget");t.contextmenu((({pageX:i,pageY:t})=>{const o=e.coordsChar({left:i,top:t}),{line:n,ch:r}=o,l=e.getTokenTypeAt(o);if(!/\bmw-(?:template-name|parserfunction)\b/.test(l))return;const d=e.getLineTokens(n);for(let e=d.length-1;e>0;e--){const{type:i,end:t,string:o}=d[e];d[e-1].type===i&&(d[e-1].end=t,d[e-1].string+=o,d.splice(e,1))}const c=d.findIndex((({start:e,end:i})=>e<r&&i>=r)),m=d[c].string.replace(/\u200E/g,"").replace(/_/g," ").trim();if(/\bmw-template-name\b/.test(l)){const e=new mw.Title(m);return 0!==e.namespace||m.startsWith(":")?open(e.getUrl(),"_blank"):open(mw.util.getUrl(`Template:${m}`),"_blank"),!1}if(c<2||!/\bmw-parserfunction-delimiter\b/.test(d[c-1].type)||!/\bmw-parserfunction-name\b/.test(d[c-2].type))return;const g=d[c-2].string.trim().toLowerCase();if(a.has(g))open(mw.util.getUrl(`Module:${m}`),"_blank");else{if(!s.has(g))return;open(mw.util.getUrl(`Widget:${m}`,{action:"edit"}),"_blank")}return!1}))},D=i.getObject("Wikiplus-highlight-i18n")||{};let N;D["wphl-version"]?((e,i)=>{const[o,n]=t(e),[a,s]=t(i);return o<a||o===a&&n<s})(D["wphl-version"],e)&&(N=a("welcome-upgrade",e,0)):N=a("welcome");const F={zh:"zh-hans","zh-hans":"zh-hans","zh-cn":"zh-hans","zh-my":"zh-hans","zh-sg":"zh-hans","zh-hant":"zh-hant","zh-tw":"zh-hant","zh-hk":"zh-hant","zh-mo":"zh-hant",ka:"ka"}[h]||"en",H=`${r}/${c}/i18n/${F}.json`,U=D["wphl-version"]===s,V=async()=>{U&&D["wphl-lang"]===F||(Object.assign(D,await $.ajax(`${H}`,{dataType:"json",cache:!0})),i.setObject("Wikiplus-highlight-i18n",D)),mw.messages.set(D)},B=Promise.all([mw.loader.using("mediawiki.util"),V()]),Q=e=>e.length>0?mw.loader.using(e):Promise.resolve(),q=e=>e.length>0?$.ajax(`${r}/${e.length>1?"combine/":""}${e.join()}`,{dataType:"script",cache:!0}):Promise.resolve(),K=async(e,i)=>{const t=e.filter((e=>!e.includes("/"))),o=e.filter((e=>e.includes("/")));return!0===i?(await Q(t),q(o)):!1===i?(await q(o),Q(t)):Promise.all([Q(t),q(o)])};let J;const R=(e,i=!1)=>{const t=[];for(const{option:o,addon:n=o,download:a=(Array.isArray(n)?o:n),only:s}of v)s&&i||o in e.optionHandlers||!G(n,W)||t.push(M[a]);return t},G=(e,i)=>Array.isArray(e)?e.some((e=>i.has(e))):i.has(e),X=e=>{let i=[];const t="function"==typeof window.CodeMirror,o=t?window.CodeMirror:{modes:{},prototype:{},commands:{},optionHandlers:{},helpers:{}};if(t||(i.push(S.lib),f||mw.loader.load(`${r}/${l}/lib/codemirror.min.css`,"text/css")),"mediawiki"===e&&y.config&&y.config.tags.html&&(e="html"),"mediawiki"!==e&&"widget"!==e||o.modes.mediawiki||(mw.loader.load(`${r}/${d}/mediawiki.min.css`,"text/css"),i.push(`${d}/mediawiki.min.js`)),"widget"===e||"html"===e)for(const e of["css","javascript","mediawiki","htmlmixed","xml"])o.modes[e]||(i=i.concat(S[e]));else i=i.concat(S[e]);if(o.prototype.getSearchCursor||!W.has("search")||W.has("wikiEditor")||i.push(M.searchcursor),!o.prototype.annotateScrollbar&&"mediawiki"===e&&W.has("lint")&&i.push(M.annotateScrollbar),o.commands.findForward||!W.has("search")||W.has("wikiEditor")||i.push(M.search),!window.wikiparse&&"mediawiki"===e&&W.has("lint")&&i.push(M.parser),!o.optionHandlers.lint&&"mediawiki"===e&&W.has("lint")&&(mw.loader.load(`${r}/${l}/addon/lint/lint.min.css`,"text/css"),i.push(M.lint)),o.helpers.lint&&o.helpers.lint.mediawiki||"mediawiki"!==e||!W.has("lint")||i.push(M.lintWikitext),W.has("wikiEditor")){const e=mw.loader.getState("ext.wikiEditor");e?"ready"!==e&&i.push(M.wikiEditor):W.delete("wikiEditor")}return"ready"!==mw.loader.getState("mediawiki.Title")&&W.has("contextmenu")&&i.push(M.contextmenu),i.push(...R(o)),K(i,t?void 0:f)},Y=e=>{b[x]={config:e,time:Date.now()},i.setObject("InPageEditMwConfig",b)},Z=e=>e.flatMap((({aliases:e,name:i})=>e.map((e=>({alias:e,name:i}))))),ee=e=>Object.fromEntries(e.map((({alias:e,name:i})=>[e.replace(/:$/,""),i]))),ie=e=>{const i=["indicator","poem","ref","tabs","tab","poll"];for(const t of i)e.tags[t]&&(e.tagModes[t]="text/mediawiki")},te=async(e,i)=>{if("mediawiki"!==e&&"widget"!==e)return;f&&j&&await i;let t=mw.config.get("extCodeMirrorConfig");if(t||j||!U||(({config:t}=y),ie(t),mw.config.set("extCodeMirrorConfig",t)),t&&t.redirect&&t.img)return t;const{query:{magicwords:o,extensiontags:n,functionhooks:a,variables:s}}=await(new mw.Api).get({meta:"siteinfo",siprop:t?"magicwords":"magicwords|extensiontags|functionhooks|variables",formatversion:2}),r=new Set(["msg","raw","msgnw","subst","safesubst"]);if(t){const{functionSynonyms:[e]}=t;if(!e.subst){const i=Z(o.filter((({name:e})=>r.has(e))));for(const{alias:t,name:o}of i)e[t.replace(/:$/,"")]=o}}else{t={tagModes:{pre:"mw-tag-pre",nowiki:"mw-tag-nowiki",ref:"text/mediawiki"},tags:Object.fromEntries(n.map((e=>[e.slice(1,-1),!0]))),urlProtocols:mw.config.get("wgUrlProtocols")};const e=new Set([...a,...s,...r]),i=o.filter((({name:i,aliases:t})=>t.some((e=>/^__.+__$/.test(e)))||e.has(i))),l=Z(i.filter((e=>e["case-sensitive"]))),d=Z(i.filter((e=>!e["case-sensitive"]))).map((({alias:e,name:i})=>({alias:e.toLowerCase(),name:i})));t.doubleUnderscore=[ee(d.filter((({alias:e})=>/^__.+__$/.test(e)))),ee(l.filter((({alias:e})=>/^__.+__$/.test(e))))],t.functionSynonyms=[ee(d.filter((({alias:e})=>!/^__.+__|^#$/.test(e)))),ee(l.filter((({alias:e})=>!/^__.+__|^#$/.test(e))))]}return t.redirect=o.find((({name:e})=>"redirect"===e)).aliases,t.img=ee(Z(o.filter((({name:e})=>e.startsWith("img_"))))),ie(t),mw.config.set("extCodeMirrorConfig",t),Y(t),t},oe={getContents:()=>J.getValue(),setContents(e){return J.setValue(e),this},getSelection:()=>J.getSelection(),setSelection(e){return J.setSelection(J.posFromIndex(e.start),"end"in e?J.posFromIndex(e.end):void 0),J.focus(),this},replaceSelection(e){return J.replaceSelection(e),this},getCaretPosition(e){const i=J.indexFromPos(J.getCursor("from")),t=J.indexFromPos(J.getCursor("to"));return e.startAndEnd?[i,t]:i},scrollToCaretPosition(){return J.scrollIntoView(),this}},ne=async(e,t)=>{const n=t?"javascript":await(async()=>{if(m.endsWith("/doc"))return"mediawiki";if(274!==g&&828!==g)return C[p];const e=274===g?"Widget":"Lua";return await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),await OO.ui.confirm(o("contentmodel"),{actions:[{label:e},{label:"Wikitext",action:"accept"}]})?"mediawiki":e.toLowerCase()})(),a=X(n),[s]=await Promise.all([te(n,a),a]);if(!t&&W.has("wikiEditor"))try{if("function"==typeof mw.addWikiEditor)mw.addWikiEditor(e);else{const{wikiEditor:{modules:{dialogs:{config:i}}}}=$;e.wikiEditor("addModule",{...$.wikiEditor.modules.toolbar.config.getDefaultConfig(),...i.getDefaultConfig()}),i.replaceIcons(e)}}catch(e){W.delete("wikiEditor"),mw.notify("WikiEditor工具栏加载失败。",{type:"error"}),console.error(e)}"mediawiki"===n&&s.tags.html?(s.tagModes.html="htmlmixed",await X("html")):"widget"!==n||CodeMirror.mimeModes.widget||CodeMirror.defineMIME("widget",{name:"htmlmixed",tags:{noinclude:[[null,null,"mediawiki"]]}});const r=e.height();J&&J.toTextArea();const l=t||"json"===p;if(J=CodeMirror.fromTextArea(e[0],$.extend({inputStyle:"contenteditable",lineNumbers:!/Android\b/.test(navigator.userAgent),lineWrapping:!0,mode:n,mwConfig:s,json:l},Object.fromEntries(v.map((({option:e,addon:i=e,modes:t,complex:o=(e=>!t||t.has(e))})=>{const a=Array.isArray(i)?i[0]:i;return[e,W.has(a)&&o(n,l)]}))),"mediawiki"===n?{extraKeys:W.has("escape")&&(T(CodeMirror)?A:L)}:{indentUnit:W.has("indentWithSpace")?O:4,indentWithTabs:!W.has("indentWithSpace")})),J.setSize(null,r),J.getWrapperElement().id="Wikiplus-CodeMirror",$.fn.textSelection&&e.textSelection("register",oe),W.has("wikiEditor")){const i=e.data("wikiEditorContext"),{keyMap:t}=CodeMirror,o=()=>{$.wikiEditor.modules.dialogs.api.openDialog(i,"search-and-replace")};J.addKeyMap(t.default===t.pcDefault?{"Ctrl-F":o}:{"Cmd-F":o})}if(P(J,n),$("#Wikiplus-Quickedit-Jump").children("a").attr("href","#Wikiplus-CodeMirror"),!t){const e=("object"==typeof window.Wikiplus?window.Wikiplus:{getSetting(e){const t=i.getObject("Wikiplus_Settings");return t&&t[e]}}).getSetting("esc_to_exit_quickedit"),t=()=>{$("#Wikiplus-Quickedit-Submit").triggerHandler("click")},o=()=>{$("#Wikiplus-Quickedit-MinorEdit").click(),$("#Wikiplus-Quickedit-Submit").triggerHandler("click")};J.addKeyMap($.extend(T(CodeMirror)?{"Ctrl-S":t,"Shift-Ctrl-S":o}:{"Cmd-S":t,"Shift-Cmd-S":o},!0===e||"true"===e?{Esc(){$("#Wikiplus-Quickedit-Back").triggerHandler("click")}}:{}))}J.refresh(),mw.hook("wiki-codemirror").fire(J)},{body:ae}=document;new MutationObserver((e=>{const i=$(e.flatMap((({addedNodes:e})=>[...e]))).find("#Wikiplus-Quickedit, #Wikiplus-Setting-Input");i.length>0&&ne(i,"Wikiplus-Setting-Input"===i.attr("id"))})).observe(ae,{childList:!0}),$(ae).on("keydown.wphl",".ui-dialog",(function(e){if("Escape"===e.key){const i=$(this).children(".ui-dialog-content").data("context");i&&i.$textarea&&"Wikiplus-Quickedit"===i.$textarea.attr("id")&&e.stopPropagation()}}));const se=document.querySelector("#wphl-style")||mw.loader.addStyleTag("#Wikiplus-CodeMirror{border:1px solid #c8ccd1;line-height:1.3;clear:both;-moz-user-select:auto;-webkit-user-select:auto;user-select:auto}#Wikiplus-CodeMirror .CodeMirror-gutter-wrapper{-moz-user-select:none;-webkit-user-select:none;user-select:none}div.Wikiplus-InterBox{font-size:14px;z-index:100}.skin-minerva .Wikiplus-InterBox{font-size:16px}.cm-trailingspace{text-decoration:underline wavy red}div.CodeMirror span.CodeMirror-matchingbracket{box-shadow:0 0 0 2px #9aef98}div.CodeMirror span.CodeMirror-nonmatchingbracket{box-shadow:0 0 0 2px #eace64}#Wikiplus-highlight-dialog .oo-ui-messageDialog-title{margin-bottom:0.28571429em}#Wikiplus-highlight-dialog .oo-ui-flaggedElement-notice{font-weight:normal;margin:0}.CodeMirror-contextmenu .cm-mw-template-name{cursor:pointer}.skin-moeskin #ca-more-actions li>a{display:inline-block;padding:0.4rem 0.8rem;line-height:1.5}.skin-moeskin .oo-ui-windowManager-modal>.oo-ui-dialog{z-index:101}");se.id="wphl-style";const{get:re=(e=>e.value),set:le=((e,i)=>{e.value=i})}=$.valHooks.textarea||{},de=e=>"Wikiplus-Quickedit"===e.id||"Wikiplus-Setting-Input"===e.id;let ce,me,ge,pe,ue,we,he,ke;$.valHooks.textarea={get:e=>de(e)&&J?J.getValue():re(e),set(e,i){de(e)&&J?J.setValue(i):le(e,i)}},await B;const fe=(e=[...W])=>{ke.toggle(e.includes("indentWithSpace"))},be=$(mw.util.addPortletLink({minerva:"page-actions-overflow",citizen:"p-actions",moeskin:"ca-more-actions"}[k]||"p-cactions","#",o("portlet"),"wphl-settings")).click((async e=>{if(e.preventDefault(),ce)me.setValue([...W]),we.setValue(O);else{await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),ce=new OO.ui.MessageDialog({id:"Wikiplus-highlight-dialog"});const e=new OO.ui.WindowManager;e.$element.appendTo(ae),e.addWindows([ce]),me=new OO.ui.CheckboxMultiselectInputWidget({options:[...v.map((({option:e,addon:i=e})=>{const t=Array.isArray(i)?i[0]:i;return{data:t,label:n(`addon-${t.toLowerCase()}`)}})),...["wikiEditor","escape","contextmenu","lint","indentWithSpace","otherEditors"].map((e=>({data:e,label:n(`addon-${e.toLowerCase()}`)})))],value:[...W]}).on("change",fe);const{checkboxMultiselectWidget:i}=me;ge=i.findItemFromData("search"),pe=i.findItemFromData("wikiEditor"),ue=i.findItemFromData("lint"),we=new OO.ui.NumberInputWidget({min:0,value:O}),he=new OO.ui.FieldLayout(me,{label:o("addon-label"),notices:[o("addon-notice")],align:"top"}),ke=new OO.ui.FieldLayout(we,{label:o("addon-indent")}),fe(),Object.assign(mw.libs.wphl,{widget:me,indentWidget:we})}const t="object"==typeof window.Wikiplus||"object"==typeof window.Pages;ge.setDisabled(!t),pe.setDisabled(!t||!mw.loader.getState("ext.wikiEditor")),ue.setDisabled(!t);const a=await ce.open({title:o("addon-title"),message:he.$element.add(ke.$element).add($("<p>",{html:o("feedback")})),actions:[{action:"reject",label:mw.msg("ooui-dialog-message-reject")},{action:"accept",label:mw.msg("ooui-dialog-message-accept"),flags:"progressive"}],size:"en"===F||"minerva"===k?"medium":"small"}).closing;if(he.$element.detach(),ke.$element.detach(),"object"==typeof a&&"accept"===a.action){const e=me.getValue();W.clear();for(const i of e)W.add(i);O=Number(we.getValue()),i.setObject("Wikiplus-highlight-addons",e),i.setObject("Wikiplus-highlight-indent",O)}}));"minerva"===k&&be.find(".mw-ui-icon").addClass("mw-ui-icon-minerva-settings"),"function"==typeof N&&N().find("#wphl-settings-notify").click((e=>{e.preventDefault(),$("#wphl-settings").triggerHandler("click")}));const xe=async e=>{if(!W.has("otherEditors"))return;let i=e.getOption("mode");i="text/mediawiki"===i?"mediawiki":i;const t=R(CodeMirror,!0),o=e.getOption("json");await K(t);for(const{option:t,addon:n=t,modes:a,complex:s=(e=>!a||a.has(e))}of v.filter((({only:e})=>!e))){const a=Array.isArray(n)?n[0]:n;void 0===e.getOption(t)&&W.has(a)&&e.setOption(t,s(i,o))}"mediawiki"===i&&W.has("escape")?e.addKeyMap(T(CodeMirror)?A:L,!0):"mediawiki"!==i&&W.has("indentWithSpace")&&(e.setOption("indentUnit",O),e.setOption("indentWithTabs",!1)),P(e,i)};mw.hook("InPageEdit.quickEdit.codemirror").add((({cm:e})=>xe(e))),mw.hook("inspector").add((e=>xe(e))),mw.hook("wiki-codemirror").add((e=>{e.getTextArea&&de(e.getTextArea())||xe(e)})),Object.assign(mw.libs.wphl,{version:e,options:v,addons:W,i18n:D,i18nLang:F,wphlStyle:se,$portlet:be,USING_LOCAL:f,MODE_LIST:S,ADDON_LIST:M,msg:o,htmlMsg:n,escapeHTML:z,handleContextMenu:P,setI18N:V,getAddonScript:R,updateCachedConfig:Y,getMwConfig:te,renderEditor:ne,handleOtherEditors:xe,isPc:T})})();
//# sourceMappingURL=/sm/ece088644b1001483fe774e98c58b562a3b5d74f48dd6f26c1ecdfe21aec0913.map
