/**
 * Generated by scripts/prefetch.js
 * Options:
 *     name: "wikiplus-highlight"
 *     url: "https://cdn.jsdelivr.net/npm/wikiplus-highlight"
 *     file: "src/gadgets/wikiplus-highlight/MediaWiki:Gadget-wikiplus-highlight.js"
 */
/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/wikiplus-highlight@2.22.5/main.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
/**
 * @name Wikiplus-highlight Wikiplus编辑器的CodeMirror语法高亮扩展
 * @author Bhsd <https://github.com/bhsd-harry>
 * @author 机智的小鱼君 <https://github.com/Dragon-Fish>
 * @license GPL-3.0
 */
(async()=>{"use strict";if(mw.libs.wphl)return;mw.libs.wphl={};const e="2.22.5",t="object"==typeof mw.storage&&"function"==typeof mw.storage.getObject?mw.storage:{getObject(e){const t=localStorage.getItem(e);if(!1===t)return!1;try{return JSON.parse(t)}catch(e){return null}},setObject(e,t){try{return localStorage.setItem(e,JSON.stringify(t))}catch(e){return!1}}},i=Object.fromEntries||(e=>{const t={};for(const[i,o]of e)t[i]=o;return t}),o=e=>"function"==typeof e.flat?e.flat():e.reduce(((e,t)=>e.concat(t)),[]),n=(t=e)=>t.split(".").map(Number),a=(e,...t)=>mw.msg(`wphl-${e}`,...t),s=(...e)=>$($.parseHTML(a(...e))),r=(...e)=>()=>{const t=$("<p>",{html:a(...e)});return mw.notify(t,{type:"success",autoHideSeconds:"long",tag:"wikiplus-highlight"}),t},d=n().slice(0,2).join("."),l="//fastly.jsdelivr.net",c="npm/codemirror@5.65.3",m="gh/bhsd-harry/codemirror-mediawiki@1.1.6",g=`npm/wikiplus-highlight@${d}`,{config:{values:{wgPageName:p,wgNamespaceNumber:u,wgPageContentModel:w,wgServerName:h,wgScriptPath:k,wgUserLanguage:f,skin:b}}}=mw,y=null!==mw.loader.getState("ext.CodeMirror"),x=t.getObject("InPageEditMwConfig")||{},C=`${h}${k}`,j=x[C]||{},S=!(j.time>Date.now()-2592e6),M={css:"css","sanitized-css":"css",javascript:"javascript",json:"javascript",wikitext:"mediawiki"},W=y?{lib:"ext.CodeMirror.lib",css:"ext.CodeMirror.lib.mode.css",javascript:"ext.CodeMirror.lib.mode.javascript",lua:`${c}/mode/lua/lua.min.js`,mediawiki:S?"ext.CodeMirror.data":[],htmlmixed:"ext.CodeMirror.lib.mode.htmlmixed",xml:[]}:{lib:`${c}/lib/codemirror.min.js`,css:`${c}/mode/css/css.min.js`,javascript:`${c}/mode/javascript/javascript.min.js`,lua:`${c}/mode/lua/lua.min.js`,mediawiki:[],htmlmixed:`${c}/mode/htmlmixed/htmlmixed.min.js`,xml:`${c}/mode/xml/xml.min.js`},v={searchcursor:`${c}/addon/search/searchcursor.min.js`,search:`${g}/search.min.js`,markSelection:`${c}/addon/selection/mark-selection.min.js`,activeLine:`${c}/addon/selection/active-line.min.js`,trailingspace:`${c}/addon/edit/trailingspace.min.js`,matchBrackets:`${c}/addon/edit/matchbrackets.min.js`,closeBrackets:`${c}/addon/edit/closebrackets.min.js`,matchTags:`${g}/matchtags.min.js`,fold:`${g}/fold.min.js`,wikiEditor:"ext.wikiEditor",contextmenu:"mediawiki.Title"},E=[{option:"styleSelectedText",addon:"search",download:"markSelection",only:!0,complex:()=>!O.has("wikiEditor")},{option:"styleActiveLine",addon:"activeLine"},{option:"showTrailingSpace",addon:"trailingspace"},{option:"matchBrackets",complex:(e,t)=>"mediawiki"!==e&&!t||{bracketRegex:/[{}[\]]/}},{option:"autoCloseBrackets",addon:"closeBrackets",complex:(e,t)=>"mediawiki"!==e&&!t||'()[]{}""'},{option:"matchTags",addon:["matchTags","fold"],modes:["mediawiki","widget"]},{option:"fold",modes:["mediawiki","widget"]}];let O=new Set(t.getObject("Wikiplus-highlight-addons")||["search"]),_=t.getObject("Wikiplus-highlight-indent")||4;const z={'"':"quot","'":"apos","<":"lt",">":"gt","&":"amp"," ":"nbsp"},I=e=>t=>{t.replaceSelection(t.getSelection().split("\n").map(e).join("\n"),"around")},T=I((e=>[...e].map((e=>{if(e in z)return`&${z[e]};`;const t=e.codePointAt();return t<256?`&#${t};`:`&#x${t.toString(16)};`})).join(""))),A=({keyMap:e})=>e.default===e.pcDefault,L={"Ctrl-/":T,"Ctrl-\\":I(encodeURIComponent)},P={"Cmd-/":T,"Cmd-\\":I(encodeURIComponent)},D=(e,t)=>{if("mediawiki"!==t&&"widget"!==t||!O.has("contextmenu"))return;const i=$(e.getWrapperElement()).addClass("CodeMirror-contextmenu"),{functionSynonyms:[o]}=mw.config.get("extCodeMirrorConfig")||{functionSynonyms:[{invoke:"invoke","调用":"invoke",widget:"widget","小工具":"widget"}]},n=e=>Object.keys(o).filter((t=>o[t]===e)).map((e=>e.startsWith("#")?e:`#${e}`)),a=n("invoke"),s=n("widget");i.contextmenu((({pageX:t,pageY:i})=>{const o=e.coordsChar({left:t,top:i}),{line:n,ch:r}=o,d=e.getTokenTypeAt(o);if(!/\bmw-(?:template-name|parserfunction)\b/.test(d))return;const l=e.getLineTokens(n);for(let e=l.length-1;e>0;e--){const{type:t,end:i,string:o}=l[e];l[e-1].type===t&&(l[e-1].end=i,l[e-1].string+=o,l.splice(e,1))}const c=l.findIndex((({start:e,end:t})=>e<r&&t>=r)),m=l[c].string.replace(/\u200E/g,"").replace(/_/g," ").trim();if(/\bmw-template-name\b/.test(d)){const e=new mw.Title(m);return 0!==e.namespace||m.startsWith(":")?open(e.getUrl(),"_blank"):open(mw.util.getUrl(`Template:${m}`),"_blank"),!1}if(c<2||!/\bmw-parserfunction-delimiter\b/.test(l[c-1].type)||!/\bmw-parserfunction-name\b/.test(l[c-2].type))return;const g=l[c-2].string.trim().toLowerCase();if(a.includes(g))open(mw.util.getUrl(`Module:${m}`),"_blank");else{if(!s.includes(g))return;open(mw.util.getUrl(`Widget:${m}`,{action:"edit"}),"_blank")}return!1}))};let N,U=t.getObject("Wikiplus-highlight-i18n");U?((e,t)=>{const[i,o]=n(e),[a,s]=n(t);return i<a||i===a&&o<s})(U["wphl-version"],e)&&(N=r("welcome-upgrade",e,0)):(U={},N=r("welcome"));const F={zh:"zh-hans","zh-hans":"zh-hans","zh-cn":"zh-hans","zh-my":"zh-hans","zh-sg":"zh-hans","zh-hant":"zh-hant","zh-tw":"zh-hant","zh-hk":"zh-hant","zh-mo":"zh-hant",ka:"ka"}[f]||"en",H=`${l}/${g}/i18n/${F}.json`,V=U["wphl-version"]===d,B=async()=>{V&&U["wphl-lang"]===F||(U=await $.ajax(`${H}`,{dataType:"json",cache:!0}),t.setObject("Wikiplus-highlight-i18n",U)),mw.messages.set(U)},Q=Promise.all([mw.loader.using("mediawiki.util"),B()]),q=e=>e.length>0?mw.loader.using(e):Promise.resolve(),K=e=>e.length>0?$.ajax(`${l}/${e.length>1?"combine/":""}${e.join()}`,{dataType:"script",cache:!0}):Promise.resolve(),J=async(e,t)=>{const i=e.filter((e=>!e.includes("/"))),o=e.filter((e=>e.includes("/")));return!0===t?(await q(i),K(o)):!1===t?(await K(o),q(i)):Promise.all([q(i),K(o)])};let R;const G=(e,t=!1)=>{const i=[];for(const{option:o,addon:n=o,download:a=(Array.isArray(n)?o:n),only:s}of E)s&&t||o in e.optionHandlers||!X(n,O)||i.push(v[a]);return i},X=(e,t)=>Array.isArray(e)?e.some((e=>t.has(e))):t.has(e),Y=e=>{let t=[];const i="function"==typeof window.CodeMirror,o=i?window.CodeMirror:{modes:{},prototype:{},commands:{},optionHandlers:{}};if(i||(t.push(W.lib),y||mw.loader.load(`${l}/${c}/lib/codemirror.min.css`,"text/css")),"mediawiki"===e&&j.config&&j.config.tags.html&&(e="html"),"mediawiki"!==e&&"widget"!==e||o.modes.mediawiki||(mw.loader.load(`${l}/${m}/mediawiki.min.css`,"text/css"),t.push(`${m}/mediawiki.min.js`)),"widget"===e||"html"===e)for(const e of["css","javascript","mediawiki","htmlmixed","xml"])o.modes[e]||(t=t.concat(W[e]));else t=t.concat(W[e]);if(o.prototype.getSearchCursor||!O.has("search")||O.has("wikiEditor")||t.push(v.searchcursor),o.commands.findForward||!O.has("search")||O.has("wikiEditor")||t.push(v.search),O.has("wikiEditor")){const e=mw.loader.getState("ext.wikiEditor");e?"ready"!==e&&t.push(v.wikiEditor):O.delete("wikiEditor")}return"ready"!==mw.loader.getState("mediawiki.Title")&&O.has("contextmenu")&&t.push(v.contextmenu),t.push(...G(o)),J(t,i?void 0:y)},Z=e=>{x[C]={config:e,time:Date.now()},t.setObject("InPageEditMwConfig",x)},ee=e=>o(e.map((({aliases:e,name:t})=>e.map((e=>({alias:e,name:t})))))),te=e=>i(e.map((({alias:e,name:t})=>[e.replace(/:$/,""),t]))),ie=async(e,t)=>{if("mediawiki"!==e&&"widget"!==e)return;y&&S&&await t;let o=mw.config.get("extCodeMirrorConfig");if(o||S||!V||(({config:o}=j),o.tags.ref&&(o.tagModes.ref="text/mediawiki"),mw.config.set("extCodeMirrorConfig",o)),o&&o.redirect&&o.img)return o;if(o)return o;const{query:{magicwords:n,extensiontags:a,functionhooks:s,variables:r}}=await(new mw.Api).get({meta:"siteinfo",siprop:o?"magicwords":"magicwords|extensiontags|functionhooks|variables",formatversion:2}),d=["msg","raw","msgnw","subst","safesubst"];if(o){const{functionSynonyms:[e]}=o;if(!e.subst){const t=ee(n.filter((({name:e})=>d.includes(e))));for(const{alias:i,name:o}of t)e[i.replace(/:$/,"")]=o}}else{o={tagModes:{pre:"mw-tag-pre",nowiki:"mw-tag-nowiki",ref:"text/mediawiki"},tags:i(a.map((e=>[e.slice(1,-1),!0]))),urlProtocols:mw.config.get("wgUrlProtocols")};const e=new Set([...s,...r,...d]),t=n.filter((({name:t,aliases:i})=>i.some((e=>/^__.+__$/.test(e)))||e.has(t))),l=ee(t.filter((e=>e["case-sensitive"]))),c=ee(t.filter((e=>!e["case-sensitive"]))).map((({alias:e,name:t})=>({alias:e.toLowerCase(),name:t})));o.doubleUnderscore=[te(c.filter((({alias:e})=>/^__.+__$/.test(e)))),te(l.filter((({alias:e})=>/^__.+__$/.test(e))))],o.functionSynonyms=[te(c.filter((({alias:e})=>!/^__.+__|^#$/.test(e)))),te(l.filter((({alias:e})=>!/^__.+__|^#$/.test(e))))]}return o.redirect=n.find((({name:e})=>"redirect"===e)).aliases,o.img=te(ee(n.filter((({name:e})=>e.startsWith("img_"))))),mw.config.set("extCodeMirrorConfig",o),Z(o),o},oe={getContents:()=>R.getValue(),setContents(e){return R.setValue(e),this},getSelection:()=>R.getSelection(),setSelection(e){return R.setSelection(R.posFromIndex(e.start),"end"in e?R.posFromIndex(e.end):void 0),R.focus(),this},replaceSelection(e){return R.replaceSelection(e),this},getCaretPosition(e){const t=R.indexFromPos(R.getCursor("from")),i=R.indexFromPos(R.getCursor("to"));return e.startAndEnd?[t,i]:t},scrollToCaretPosition(){return R.scrollIntoView(),this}},ne=async(e,o)=>{const n=o?"javascript":await(async()=>{if(!(274!==u&&828!==u||p.endsWith("/doc"))){const e=274===u?"Widget":"Lua";return await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),await OO.ui.confirm(a("contentmodel"),{actions:[{label:e},{label:"Wikitext",action:"accept"}]})?"mediawiki":e.toLowerCase()}return p.endsWith("/doc")?"mediawiki":M[w]})(),s=Y(n),[r]=await Promise.all([ie(n,s),s]);if(!o&&O.has("wikiEditor"))try{if("function"==typeof mw.addWikiEditor)mw.addWikiEditor(e);else{const{wikiEditor:{modules:{dialogs:{config:t}}}}=$;e.wikiEditor("addModule",{...$.wikiEditor.modules.toolbar.config.getDefaultConfig(),...t.getDefaultConfig()}),t.replaceIcons(e)}}catch(e){O.delete("wikiEditor"),mw.notify("WikiEditor工具栏加载失败。",{type:"error"}),console.error(e)}"mediawiki"===n&&r.tags.html?(r.tagModes.html="htmlmixed",await Y("html")):"widget"!==n||CodeMirror.mimeModes.widget||CodeMirror.defineMIME("widget",{name:"htmlmixed",tags:{noinclude:[[null,null,"mediawiki"]]}});const d=e.height();R&&R.toTextArea();const l=o||"json"===w;if(R=CodeMirror.fromTextArea(e[0],$.extend({inputStyle:"contenteditable",lineNumbers:!/Android\b/.test(navigator.userAgent),lineWrapping:!0,mode:n,mwConfig:r,json:l},i(E.map((({option:e,addon:t=e,modes:i,complex:o=(e=>!i||i.includes(e))})=>{const a=Array.isArray(t)?t[0]:t;return[e,O.has(a)&&o(n,l)]}))),"mediawiki"===n?{extraKeys:O.has("escape")&&(A(CodeMirror)?L:P)}:{indentUnit:O.has("indentWithSpace")?_:4,indentWithTabs:!O.has("indentWithSpace")})),R.setSize(null,d),R.getWrapperElement().id="Wikiplus-CodeMirror",$.fn.textSelection&&e.textSelection("register",oe),O.has("wikiEditor")){const t=e.data("wikiEditorContext"),{keyMap:i}=CodeMirror,o=()=>{$.wikiEditor.modules.dialogs.api.openDialog(t,"search-and-replace")};R.addKeyMap(i.default===i.pcDefault?{"Ctrl-F":o}:{"Cmd-F":o})}if(D(R,n),$("#Wikiplus-Quickedit-Jump").children("a").attr("href","#Wikiplus-CodeMirror"),!o){const e=("object"==typeof window.Wikiplus?window.Wikiplus:{getSetting(e){const i=t.getObject("Wikiplus_Settings");return i&&i[e]}}).getSetting("esc_to_exit_quickedit"),i=()=>{$("#Wikiplus-Quickedit-Submit").triggerHandler("click")},o=()=>{$("#Wikiplus-Quickedit-MinorEdit").click(),$("#Wikiplus-Quickedit-Submit").triggerHandler("click")};R.addKeyMap($.extend(A(CodeMirror)?{"Ctrl-S":i,"Shift-Ctrl-S":o}:{"Cmd-S":i,"Shift-Cmd-S":o},!0===e||"true"===e?{Esc(){$("#Wikiplus-Quickedit-Back").triggerHandler("click")}}:{}))}R.refresh(),mw.hook("wiki-codemirror").fire(R)},{body:ae}=document;new MutationObserver((e=>{const t=$(o(e.map((({addedNodes:e})=>[...e])))).find("#Wikiplus-Quickedit, #Wikiplus-Setting-Input");0!==t.length&&ne(t,"Wikiplus-Setting-Input"===t.attr("id"))})).observe(ae,{childList:!0}),$(ae).on("keydown.wphl",".ui-dialog",(function(e){if("Escape"===e.key){const t=$(this).children(".ui-dialog-content").data("context");t&&t.$textarea&&"Wikiplus-Quickedit"===t.$textarea.attr("id")&&e.stopPropagation()}}));const se=document.querySelector("#wphl-style")||mw.loader.addStyleTag("#Wikiplus-CodeMirror{border:1px solid #c8ccd1;line-height:1.3;clear:both;-moz-user-select:auto;-webkit-user-select:auto;user-select:auto}#Wikiplus-CodeMirror .CodeMirror-gutter-wrapper{-moz-user-select:none;-webkit-user-select:none;user-select:none}div.Wikiplus-InterBox{font-size:14px;z-index:100}.skin-minerva .Wikiplus-InterBox{font-size:16px}.cm-trailingspace{text-decoration:underline wavy red}div.CodeMirror span.CodeMirror-matchingbracket{box-shadow:0 0 0 2px #9aef98}div.CodeMirror span.CodeMirror-nonmatchingbracket{box-shadow:0 0 0 2px #eace64}#Wikiplus-highlight-dialog .oo-ui-messageDialog-title{margin-bottom:0.28571429em}#Wikiplus-highlight-dialog .oo-ui-flaggedElement-notice{font-weight:normal;margin:0}.CodeMirror-contextmenu .cm-mw-template-name{cursor:pointer}.skin-moeskin #ca-more-actions li>a{display:inline-block;padding:0.4rem 0.8rem;line-height:1.5}");se.id="wphl-style";const{get:re=(e=>e.value),set:de=((e,t)=>{e.value=t})}=$.valHooks.textarea||{},le=e=>"Wikiplus-Quickedit"===e.id||"Wikiplus-Setting-Input"===e.id;let ce,me,ge,pe,ue,we,he;$.valHooks.textarea={get:e=>le(e)&&R?R.getValue():re(e),set(e,t){le(e)&&R?R.setValue(t):de(e,t)}},await Q;const ke=(e=[...O])=>{he.toggle(e.includes("indentWithSpace"))},fe=$(mw.util.addPortletLink({minerva:"page-actions-overflow",citizen:"p-actions",moeskin:"ca-more-actions"}[b]||"p-cactions","#",a("portlet"),"wphl-settings")).click((async e=>{if(e.preventDefault(),ce)me.setValue([...O]),ue.setValue(_);else{await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),ce=new OO.ui.MessageDialog({id:"Wikiplus-highlight-dialog"});const e=new OO.ui.WindowManager;e.$element.appendTo(ae),e.addWindows([ce]),me=new OO.ui.CheckboxMultiselectInputWidget({options:[...E.map((({option:e,addon:t=e})=>{const i=Array.isArray(t)?t[0]:t;return{data:i,label:s(`addon-${i.toLowerCase()}`)}})),...["wikiEditor","escape","contextmenu","indentWithSpace","otherEditors"].map((e=>({data:e,label:s(`addon-${e.toLowerCase()}`)})))],value:[...O]}).on("change",ke);const{checkboxMultiselectWidget:t}=me;ge=t.findItemFromData("search"),pe=t.findItemFromData("wikiEditor"),ue=new OO.ui.NumberInputWidget({min:0,value:_}),we=new OO.ui.FieldLayout(me,{label:a("addon-label"),notices:[a("addon-notice")],align:"top"}),he=new OO.ui.FieldLayout(ue,{label:a("addon-indent")}),ke(),Object.assign(mw.libs.wphl,{widget:me,indentWidget:ue})}const i="object"==typeof window.Wikiplus||"object"==typeof window.Pages;ge.setDisabled(!i),pe.setDisabled(!i||!mw.loader.getState("ext.wikiEditor"));const o=await ce.open({title:a("addon-title"),message:we.$element.add(he.$element).add($("<p>",{html:a("feedback")})),actions:[{action:"reject",label:mw.msg("ooui-dialog-message-reject")},{action:"accept",label:mw.msg("ooui-dialog-message-accept"),flags:"progressive"}],size:"en"===F||"minerva"===b?"medium":"small"}).closing;if(we.$element.detach(),he.$element.detach(),"object"==typeof o&&"accept"===o.action){const e=me.getValue();O=new Set(e),_=Number(ue.getValue()),t.setObject("Wikiplus-highlight-addons",e),t.setObject("Wikiplus-highlight-indent",_)}}));"minerva"===b&&fe.find(".mw-ui-icon").addClass("mw-ui-icon-minerva-settings"),"function"==typeof N&&N().find("#wphl-settings-notify").click((e=>{e.preventDefault(),$("#wphl-settings").triggerHandler("click")}));const be=async e=>{if(!O.has("otherEditors"))return;let t=e.getOption("mode");t="text/mediawiki"===t?"mediawiki":t;const i=G(CodeMirror,!0),o=e.getOption("json");await J(i);for(const{option:i,addon:n=i,modes:a,complex:s=(e=>!a||a.includes(e))}of E.filter((({only:e})=>!e))){const a=Array.isArray(n)?n[0]:n;void 0===e.getOption(i)&&O.has(a)&&e.setOption(i,s(t,o))}"mediawiki"!==t&&O.has("indentWithSpace")?(e.setOption("indentUnit",_),e.setOption("indentWithTabs",!1)):"mediawiki"===t&&O.has("escape")&&e.addKeyMap(A(CodeMirror)?L:P,!0),D(e,t)};mw.hook("InPageEdit.quickEdit.codemirror").add((({cm:e})=>be(e))),mw.hook("inspector").add((e=>be(e))),mw.libs.wphl={version:e,options:E,addons:O,i18n:U,i18nLang:F,wphlStyle:se,$portlet:fe,USING_LOCAL:y,MODE_LIST:W,ADDON_LIST:v,msg:a,htmlMsg:s,escapeHTML:T,handleContextMenu:D,setI18N:B,getAddonScript:G,updateCachedConfig:Z,getMwConfig:ie,renderEditor:ne,handleOtherEditors:be}})();
//# sourceMappingURL=/sm/622564bd86ac6bb091bfa55ad72107168aea52bf96b76872526234d0f293d0ef.map
