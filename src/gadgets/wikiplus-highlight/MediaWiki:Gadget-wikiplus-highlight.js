/**
 * Generated by scripts/prefetch.js
 * Options:
 *     name: "wikiplus-highlight"
 *     url: "https://cdn.jsdelivr.net/npm/wikiplus-highlight"
 *     file: "src/gadgets/wikiplus-highlight/MediaWiki:Gadget-wikiplus-highlight.js"
 */
/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/wikiplus-highlight@2.30.0/main.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
/**
 * @name Wikiplus-highlight Wikiplus编辑器的CodeMirror语法高亮扩展
 * @author Bhsd <https://github.com/bhsd-harry>
 * @author 机智的小鱼君 <https://github.com/Dragon-Fish>
 * @license GPL-3.0
 */
(async()=>{"use strict";if(mw.libs.wphl)return;mw.libs.wphl={};const e="2.30",t="object"==typeof mw.storage&&"function"==typeof mw.storage.getObject?mw.storage:{getObject(e){const t=localStorage.getItem(e);if(!1===t)return!1;try{return JSON.parse(t)}catch(e){return null}},setObject(e,t){try{return localStorage.setItem(e,JSON.stringify(t))}catch(e){return!1}}};Object.fromEntries=Object.fromEntries||(e=>{const t={};for(const[i,o]of e)t[i]=o;return t});const i=e=>"function"==typeof e.flat?e.flat():e.reduce(((e,t)=>e.concat(t)),[]),o=(e="2.30")=>e.split(".").map(Number),n=(e,...t)=>mw.msg(`wphl-${e}`,...t),a=(...e)=>$($.parseHTML(n(...e))),s=(...e)=>()=>{const t=$("<p>",{html:n(...e)});return mw.notify(t,{type:"success",autoHideSeconds:"long",tag:"wikiplus-highlight"}),t},r=o().slice(0,2).join("."),l="//fastly.jsdelivr.net",d="npm/codemirror@5.65.3",c="gh/bhsd-harry/codemirror-mediawiki@1.1.6",m=`npm/wikiplus-highlight@${r}`,{config:{values:{wgPageName:g,wgNamespaceNumber:p,wgPageContentModel:u,wgServerName:w,wgScriptPath:h,wgUserLanguage:k,skin:f}}}=mw,b=null!==mw.loader.getState("ext.CodeMirror"),x=t.getObject("InPageEditMwConfig")||{},y=`${w}${h}`,C=x[y]||{},j=!(C.time>Date.now()-2592e6),S={css:"css","sanitized-css":"css",javascript:"javascript",json:"javascript",wikitext:"mediawiki"},M=b?{lib:"ext.CodeMirror.lib",css:"ext.CodeMirror.lib.mode.css",javascript:"ext.CodeMirror.lib.mode.javascript",lua:`${d}/mode/lua/lua.min.js`,mediawiki:j?"ext.CodeMirror.data":[],htmlmixed:"ext.CodeMirror.lib.mode.htmlmixed",xml:[]}:{lib:`${d}/lib/codemirror.min.js`,css:`${d}/mode/css/css.min.js`,javascript:`${d}/mode/javascript/javascript.min.js`,lua:`${d}/mode/lua/lua.min.js`,mediawiki:[],htmlmixed:`${d}/mode/htmlmixed/htmlmixed.min.js`,xml:`${d}/mode/xml/xml.min.js`},W={searchcursor:`${d}/addon/search/searchcursor.min.js`,search:`${m}/search.min.js`,markSelection:`${d}/addon/selection/mark-selection.min.js`,activeLine:`${d}/addon/selection/active-line.min.js`,trailingspace:`${d}/addon/edit/trailingspace.min.js`,matchBrackets:`${d}/addon/edit/matchbrackets.min.js`,closeBrackets:`${d}/addon/edit/closebrackets.min.js`,matchTags:`${m}/matchtags.min.js`,fold:`${m}/fold.min.js`,wikiEditor:"ext.wikiEditor",contextmenu:"mediawiki.Title",lint:`${d}/addon/lint/lint.min.js`,annotateScrollbar:`${d}/addon/scroll/annotatescrollbar.min.js`,parser:"npm/wikiparser-node@0.6.5-b/bundle/bundle.min.js",lintWikitext:`${m}/lint.min.js`},v=[{option:"styleSelectedText",addon:"search",download:"markSelection",only:!0,complex:()=>!O.has("wikiEditor")},{option:"styleActiveLine",addon:"activeLine"},{option:"showTrailingSpace",addon:"trailingspace"},{option:"matchBrackets",complex:(e,t)=>"mediawiki"!==e&&!t||{bracketRegex:/[{}[\]]/}},{option:"autoCloseBrackets",addon:"closeBrackets",complex:(e,t)=>"mediawiki"!==e&&!t||'()[]{}""'},{option:"matchTags",addon:["matchTags","fold"],modes:new Set(["mediawiki","widget"])},{option:"fold",modes:new Set(["mediawiki","widget"])}],O=new Set(t.getObject("Wikiplus-highlight-addons")||["search"]);let E=t.getObject("Wikiplus-highlight-indent")||4;const _={'"':"quot","'":"apos","<":"lt",">":"gt","&":"amp"," ":"nbsp"},z=e=>t=>{t.replaceSelection(t.getSelection().split("\n").map(e).join("\n"),"around")},I=z((e=>[...e].map((e=>{if(e in _)return`&${_[e]};`;const t=e.codePointAt();return t<256?`&#${t};`:`&#x${t.toString(16)};`})).join(""))),T=({keyMap:e})=>e.default===e.pcDefault,A={"Ctrl-/":I,"Ctrl-\\":z(encodeURIComponent)},P={"Cmd-/":I,"Cmd-\\":z(encodeURIComponent)},L=(e,t)=>{if("mediawiki"!==t&&"widget"!==t||!O.has("contextmenu"))return;const i=$(e.getWrapperElement()).addClass("CodeMirror-contextmenu"),{functionSynonyms:[o]}=mw.config.get("extCodeMirrorConfig")||{functionSynonyms:[{invoke:"invoke","调用":"invoke",widget:"widget","小工具":"widget"}]},n=e=>new Set(Object.keys(o).filter((t=>o[t]===e)).map((e=>e.startsWith("#")?e:`#${e}`))),a=n("invoke"),s=n("widget");i.contextmenu((({pageX:t,pageY:i})=>{const o=e.coordsChar({left:t,top:i}),{line:n,ch:r}=o,l=e.getTokenTypeAt(o);if(!/\bmw-(?:template-name|parserfunction)\b/.test(l))return;const d=e.getLineTokens(n);for(let e=d.length-1;e>0;e--){const{type:t,end:i,string:o}=d[e];d[e-1].type===t&&(d[e-1].end=i,d[e-1].string+=o,d.splice(e,1))}const c=d.findIndex((({start:e,end:t})=>e<r&&t>=r)),m=d[c].string.replace(/\u200E/g,"").replace(/_/g," ").trim();if(/\bmw-template-name\b/.test(l)){const e=new mw.Title(m);return 0!==e.namespace||m.startsWith(":")?open(e.getUrl(),"_blank"):open(mw.util.getUrl(`Template:${m}`),"_blank"),!1}if(c<2||!/\bmw-parserfunction-delimiter\b/.test(d[c-1].type)||!/\bmw-parserfunction-name\b/.test(d[c-2].type))return;const g=d[c-2].string.trim().toLowerCase();if(a.has(g))open(mw.util.getUrl(`Module:${m}`),"_blank");else{if(!s.has(g))return;open(mw.util.getUrl(`Widget:${m}`,{action:"edit"}),"_blank")}return!1}))},D=t.getObject("Wikiplus-highlight-i18n")||{};let N;D["wphl-version"]?((e,t)=>{const[i,n]=o(e),[a,s]=o(t);return i<a||i===a&&n<s})(D["wphl-version"],e)&&(N=s("welcome-upgrade",e,0)):N=s("welcome");const F={zh:"zh-hans","zh-hans":"zh-hans","zh-cn":"zh-hans","zh-my":"zh-hans","zh-sg":"zh-hans","zh-hant":"zh-hant","zh-tw":"zh-hant","zh-hk":"zh-hant","zh-mo":"zh-hant",ka:"ka"}[k]||"en",H=`${l}/${m}/i18n/${F}.json`,U=D["wphl-version"]===r,V=async()=>{U&&D["wphl-lang"]===F||(Object.assign(D,await $.ajax(`${H}`,{dataType:"json",cache:!0})),t.setObject("Wikiplus-highlight-i18n",D)),mw.messages.set(D)},B=Promise.all([mw.loader.using("mediawiki.util"),V()]),Q=e=>e.length>0?mw.loader.using(e):Promise.resolve(),q=e=>e.length>0?$.ajax(`${l}/${e.length>1?"combine/":""}${e.join()}`,{dataType:"script",cache:!0}):Promise.resolve(),K=async(e,t)=>{const i=e.filter((e=>!e.includes("/"))),o=e.filter((e=>e.includes("/")));return!0===t?(await Q(i),q(o)):!1===t?(await q(o),Q(i)):Promise.all([Q(i),q(o)])};let J;const R=(e,t=!1)=>{const i=[];for(const{option:o,addon:n=o,download:a=(Array.isArray(n)?o:n),only:s}of v)s&&t||o in e.optionHandlers||!G(n,O)||i.push(W[a]);return i},G=(e,t)=>Array.isArray(e)?e.some((e=>t.has(e))):t.has(e),X=e=>{let t=[];const i="function"==typeof window.CodeMirror,o=i?window.CodeMirror:{modes:{},prototype:{},commands:{},optionHandlers:{},helpers:{}};if(i||(t.push(M.lib),b||mw.loader.load(`${l}/${d}/lib/codemirror.min.css`,"text/css")),"mediawiki"===e&&C.config&&C.config.tags.html&&(e="html"),"mediawiki"!==e&&"widget"!==e||o.modes.mediawiki||(mw.loader.load(`${l}/${c}/mediawiki.min.css`,"text/css"),t.push(`${c}/mediawiki.min.js`)),"widget"===e||"html"===e)for(const e of["css","javascript","mediawiki","htmlmixed","xml"])o.modes[e]||(t=t.concat(M[e]));else t=t.concat(M[e]);if(o.prototype.getSearchCursor||!O.has("search")||O.has("wikiEditor")||t.push(W.searchcursor),!o.prototype.annotateScrollbar&&"mediawiki"===e&&O.has("lint")&&t.push(W.annotateScrollbar),o.commands.findForward||!O.has("search")||O.has("wikiEditor")||t.push(W.search),!window.Parser&&"mediawiki"===e&&O.has("lint")&&t.push(W.parser),!o.optionHandlers.lint&&"mediawiki"===e&&O.has("lint")&&(mw.loader.load(`${l}/${d}/addon/lint/lint.min.css`,"text/css"),t.push(W.lint)),o.helpers.lint&&o.helpers.lint.mediawiki||"mediawiki"!==e||!O.has("lint")||t.push(W.lintWikitext),O.has("wikiEditor")){const e=mw.loader.getState("ext.wikiEditor");e?"ready"!==e&&t.push(W.wikiEditor):O.delete("wikiEditor")}return"ready"!==mw.loader.getState("mediawiki.Title")&&O.has("contextmenu")&&t.push(W.contextmenu),t.push(...R(o)),K(t,i?void 0:b)},Y=e=>{x[y]={config:e,time:Date.now()},t.setObject("InPageEditMwConfig",x)},Z=e=>i(e.map((({aliases:e,name:t})=>e.map((e=>({alias:e,name:t})))))),ee=e=>Object.fromEntries(e.map((({alias:e,name:t})=>[e.replace(/:$/,""),t]))),te=async(e,t)=>{if("mediawiki"!==e&&"widget"!==e)return;b&&j&&await t;let i=mw.config.get("extCodeMirrorConfig");if(i||j||!U||(({config:i}=C),i.tags.ref&&(i.tagModes.ref="text/mediawiki"),mw.config.set("extCodeMirrorConfig",i)),i&&i.redirect&&i.img)return i;const{query:{magicwords:o,extensiontags:n,functionhooks:a,variables:s}}=await(new mw.Api).get({meta:"siteinfo",siprop:i?"magicwords":"magicwords|extensiontags|functionhooks|variables",formatversion:2}),r=new Set(["msg","raw","msgnw","subst","safesubst"]);if(i){const{functionSynonyms:[e]}=i;if(!e.subst){const t=Z(o.filter((({name:e})=>r.has(e))));for(const{alias:i,name:o}of t)e[i.replace(/:$/,"")]=o}}else{i={tagModes:{pre:"mw-tag-pre",nowiki:"mw-tag-nowiki",ref:"text/mediawiki"},tags:Object.fromEntries(n.map((e=>[e.slice(1,-1),!0]))),urlProtocols:mw.config.get("wgUrlProtocols")};const e=new Set([...a,...s,...r]),t=o.filter((({name:t,aliases:i})=>i.some((e=>/^__.+__$/.test(e)))||e.has(t))),l=Z(t.filter((e=>e["case-sensitive"]))),d=Z(t.filter((e=>!e["case-sensitive"]))).map((({alias:e,name:t})=>({alias:e.toLowerCase(),name:t})));i.doubleUnderscore=[ee(d.filter((({alias:e})=>/^__.+__$/.test(e)))),ee(l.filter((({alias:e})=>/^__.+__$/.test(e))))],i.functionSynonyms=[ee(d.filter((({alias:e})=>!/^__.+__|^#$/.test(e)))),ee(l.filter((({alias:e})=>!/^__.+__|^#$/.test(e))))]}return i.redirect=o.find((({name:e})=>"redirect"===e)).aliases,i.img=ee(Z(o.filter((({name:e})=>e.startsWith("img_"))))),mw.config.set("extCodeMirrorConfig",i),Y(i),i},ie={getContents:()=>J.getValue(),setContents(e){return J.setValue(e),this},getSelection:()=>J.getSelection(),setSelection(e){return J.setSelection(J.posFromIndex(e.start),"end"in e?J.posFromIndex(e.end):void 0),J.focus(),this},replaceSelection(e){return J.replaceSelection(e),this},getCaretPosition(e){const t=J.indexFromPos(J.getCursor("from")),i=J.indexFromPos(J.getCursor("to"));return e.startAndEnd?[t,i]:t},scrollToCaretPosition(){return J.scrollIntoView(),this}},oe=async(e,i)=>{const o=i?"javascript":await(async()=>{if(g.endsWith("/doc"))return"mediawiki";if(274!==p&&828!==p)return S[u];const e=274===p?"Widget":"Lua";return await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),await OO.ui.confirm(n("contentmodel"),{actions:[{label:e},{label:"Wikitext",action:"accept"}]})?"mediawiki":e.toLowerCase()})(),a=X(o),[s]=await Promise.all([te(o,a),a]);if(!i&&O.has("wikiEditor"))try{if("function"==typeof mw.addWikiEditor)mw.addWikiEditor(e);else{const{wikiEditor:{modules:{dialogs:{config:t}}}}=$;e.wikiEditor("addModule",{...$.wikiEditor.modules.toolbar.config.getDefaultConfig(),...t.getDefaultConfig()}),t.replaceIcons(e)}}catch(e){O.delete("wikiEditor"),mw.notify("WikiEditor工具栏加载失败。",{type:"error"}),console.error(e)}"mediawiki"===o&&s.tags.html?(s.tagModes.html="htmlmixed",await X("html")):"widget"!==o||CodeMirror.mimeModes.widget||CodeMirror.defineMIME("widget",{name:"htmlmixed",tags:{noinclude:[[null,null,"mediawiki"]]}});const r=e.height();J&&J.toTextArea();const l=i||"json"===u;if(J=CodeMirror.fromTextArea(e[0],$.extend({inputStyle:"contenteditable",lineNumbers:!/Android\b/.test(navigator.userAgent),lineWrapping:!0,mode:o,mwConfig:s,json:l},Object.fromEntries(v.map((({option:e,addon:t=e,modes:i,complex:n=(e=>!i||i.has(e))})=>{const a=Array.isArray(t)?t[0]:t;return[e,O.has(a)&&n(o,l)]}))),"mediawiki"===o?{extraKeys:O.has("escape")&&(T(CodeMirror)?A:P)}:{indentUnit:O.has("indentWithSpace")?E:4,indentWithTabs:!O.has("indentWithSpace")})),J.setSize(null,r),J.getWrapperElement().id="Wikiplus-CodeMirror",$.fn.textSelection&&e.textSelection("register",ie),O.has("wikiEditor")){const t=e.data("wikiEditorContext"),{keyMap:i}=CodeMirror,o=()=>{$.wikiEditor.modules.dialogs.api.openDialog(t,"search-and-replace")};J.addKeyMap(i.default===i.pcDefault?{"Ctrl-F":o}:{"Cmd-F":o})}if(L(J,o),$("#Wikiplus-Quickedit-Jump").children("a").attr("href","#Wikiplus-CodeMirror"),!i){const e=("object"==typeof window.Wikiplus?window.Wikiplus:{getSetting(e){const i=t.getObject("Wikiplus_Settings");return i&&i[e]}}).getSetting("esc_to_exit_quickedit"),i=()=>{$("#Wikiplus-Quickedit-Submit").triggerHandler("click")},o=()=>{$("#Wikiplus-Quickedit-MinorEdit").click(),$("#Wikiplus-Quickedit-Submit").triggerHandler("click")};J.addKeyMap($.extend(T(CodeMirror)?{"Ctrl-S":i,"Shift-Ctrl-S":o}:{"Cmd-S":i,"Shift-Cmd-S":o},!0===e||"true"===e?{Esc(){$("#Wikiplus-Quickedit-Back").triggerHandler("click")}}:{}))}J.refresh(),mw.hook("wiki-codemirror").fire(J)},{body:ne}=document;new MutationObserver((e=>{const t=$(i(e.map((({addedNodes:e})=>[...e])))).find("#Wikiplus-Quickedit, #Wikiplus-Setting-Input");t.length>0&&oe(t,"Wikiplus-Setting-Input"===t.attr("id"))})).observe(ne,{childList:!0}),$(ne).on("keydown.wphl",".ui-dialog",(function(e){if("Escape"===e.key){const t=$(this).children(".ui-dialog-content").data("context");t&&t.$textarea&&"Wikiplus-Quickedit"===t.$textarea.attr("id")&&e.stopPropagation()}}));const ae=document.querySelector("#wphl-style")||mw.loader.addStyleTag("#Wikiplus-CodeMirror{border:1px solid #c8ccd1;line-height:1.3;clear:both;-moz-user-select:auto;-webkit-user-select:auto;user-select:auto}#Wikiplus-CodeMirror .CodeMirror-gutter-wrapper{-moz-user-select:none;-webkit-user-select:none;user-select:none}div.Wikiplus-InterBox{font-size:14px;z-index:100}.skin-minerva .Wikiplus-InterBox{font-size:16px}.cm-trailingspace{text-decoration:underline wavy red}div.CodeMirror span.CodeMirror-matchingbracket{box-shadow:0 0 0 2px #9aef98}div.CodeMirror span.CodeMirror-nonmatchingbracket{box-shadow:0 0 0 2px #eace64}#Wikiplus-highlight-dialog .oo-ui-messageDialog-title{margin-bottom:0.28571429em}#Wikiplus-highlight-dialog .oo-ui-flaggedElement-notice{font-weight:normal;margin:0}.CodeMirror-contextmenu .cm-mw-template-name{cursor:pointer}.skin-moeskin #ca-more-actions li>a{display:inline-block;padding:0.4rem 0.8rem;line-height:1.5}");ae.id="wphl-style";const{get:se=(e=>e.value),set:re=((e,t)=>{e.value=t})}=$.valHooks.textarea||{},le=e=>"Wikiplus-Quickedit"===e.id||"Wikiplus-Setting-Input"===e.id;let de,ce,me,ge,pe,ue,we,he;$.valHooks.textarea={get:e=>le(e)&&J?J.getValue():se(e),set(e,t){le(e)&&J?J.setValue(t):re(e,t)}},await B;const ke=(e=[...O])=>{he.toggle(e.includes("indentWithSpace"))},fe=$(mw.util.addPortletLink({minerva:"page-actions-overflow",citizen:"p-actions",moeskin:"ca-more-actions"}[f]||"p-cactions","#",n("portlet"),"wphl-settings")).click((async e=>{if(e.preventDefault(),de)ce.setValue([...O]),ue.setValue(E);else{await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),de=new OO.ui.MessageDialog({id:"Wikiplus-highlight-dialog"});const e=new OO.ui.WindowManager;e.$element.appendTo(ne),e.addWindows([de]),ce=new OO.ui.CheckboxMultiselectInputWidget({options:[...v.map((({option:e,addon:t=e})=>{const i=Array.isArray(t)?t[0]:t;return{data:i,label:a(`addon-${i.toLowerCase()}`)}})),...["wikiEditor","escape","contextmenu","lint","indentWithSpace","otherEditors"].map((e=>({data:e,label:a(`addon-${e.toLowerCase()}`)})))],value:[...O]}).on("change",ke);const{checkboxMultiselectWidget:t}=ce;me=t.findItemFromData("search"),ge=t.findItemFromData("wikiEditor"),pe=t.findItemFromData("lint"),ue=new OO.ui.NumberInputWidget({min:0,value:E}),we=new OO.ui.FieldLayout(ce,{label:n("addon-label"),notices:[n("addon-notice")],align:"top"}),he=new OO.ui.FieldLayout(ue,{label:n("addon-indent")}),ke(),Object.assign(mw.libs.wphl,{widget:ce,indentWidget:ue})}const i="object"==typeof window.Wikiplus||"object"==typeof window.Pages;me.setDisabled(!i),ge.setDisabled(!i||!mw.loader.getState("ext.wikiEditor")),pe.setDisabled(!i);const o=await de.open({title:n("addon-title"),message:we.$element.add(he.$element).add($("<p>",{html:n("feedback")})),actions:[{action:"reject",label:mw.msg("ooui-dialog-message-reject")},{action:"accept",label:mw.msg("ooui-dialog-message-accept"),flags:"progressive"}],size:"en"===F||"minerva"===f?"medium":"small"}).closing;if(we.$element.detach(),he.$element.detach(),"object"==typeof o&&"accept"===o.action){const e=ce.getValue();O.clear();for(const t of e)O.add(t);E=Number(ue.getValue()),t.setObject("Wikiplus-highlight-addons",e),t.setObject("Wikiplus-highlight-indent",E)}}));"minerva"===f&&fe.find(".mw-ui-icon").addClass("mw-ui-icon-minerva-settings"),"function"==typeof N&&N().find("#wphl-settings-notify").click((e=>{e.preventDefault(),$("#wphl-settings").triggerHandler("click")}));const be=async e=>{if(!O.has("otherEditors"))return;let t=e.getOption("mode");t="text/mediawiki"===t?"mediawiki":t;const i=R(CodeMirror,!0),o=e.getOption("json");await K(i);for(const{option:i,addon:n=i,modes:a,complex:s=(e=>!a||a.has(e))}of v.filter((({only:e})=>!e))){const a=Array.isArray(n)?n[0]:n;void 0===e.getOption(i)&&O.has(a)&&e.setOption(i,s(t,o))}"mediawiki"===t&&O.has("escape")?e.addKeyMap(T(CodeMirror)?A:P,!0):"mediawiki"!==t&&O.has("indentWithSpace")&&(e.setOption("indentUnit",E),e.setOption("indentWithTabs",!1)),L(e,t)};mw.hook("InPageEdit.quickEdit.codemirror").add((({cm:e})=>be(e))),mw.hook("inspector").add((e=>be(e))),mw.hook("wiki-codemirror").add((e=>{e.getTextArea&&le(e.getTextArea())||be(e)})),mw.libs.wphl={version:e,options:v,addons:O,i18n:D,i18nLang:F,wphlStyle:ae,$portlet:fe,USING_LOCAL:b,MODE_LIST:M,ADDON_LIST:W,msg:n,htmlMsg:a,escapeHTML:I,handleContextMenu:L,setI18N:V,getAddonScript:R,updateCachedConfig:Y,getMwConfig:te,renderEditor:oe,handleOtherEditors:be,isPc:T}})();
//# sourceMappingURL=/sm/0f7e55de199b095c60b45846196882c416720ad690756880ef9272ac9542e409.map
